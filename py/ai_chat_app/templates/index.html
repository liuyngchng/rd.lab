<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIèŠå¤©åŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-robot"></i> AIèŠå¤©åŠ©æ‰‹</h1>
            <div class="model-info">
                <span id="modelName">æ­£åœ¨åŠ è½½æ¨¡å‹ä¿¡æ¯...</span>
                <button id="clearChat" class="btn-clear">
                    <i class="fas fa-trash-alt"></i> æ¸…ç©ºèŠå¤©
                </button>
            </div>
        </header>

        <div class="chat-container">
            <div class="chat-history" id="chatHistory">
                <!-- èŠå¤©æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                <div class="welcome-message">
                    <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</p>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." 
                        rows="3"
                        onkeydown="handleKeyPress(event)"
                    ></textarea>
                    <div class="input-actions">
                        <div class="config-info">
                            <span class="config-item">
                                <i class="fas fa-brain"></i>
                                <span id="currentModel">-</span>
                            </span>
                            <span class="config-item">
                                <i class="fas fa-thermometer-half"></i>
                                <span id="currentTemp">{{ '%.1f'|format(config.temperature|default(0.7)) }}</span>
                            </span>
                        </div>
                        <button id="sendButton" class="btn-send">
                            <i class="fas fa-paper-plane"></i> å‘é€
                        </button>
                    </div>
                </div>
                <div class="input-hint">
                    <small>æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</small>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Powered by Flask & LLM API | æ”¯æŒæµå¼å“åº”</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let chatHistory = [];
        let currentStream = null;

        // DOM å…ƒç´ 
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatHistoryEl = document.getElementById('chatHistory');
        const clearChatBtn = document.getElementById('clearChat');
        const modelNameEl = document.getElementById('modelName');
        const currentModelEl = document.getElementById('currentModel');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            setupEventListeners();
            messageInput.focus();
        });

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                
                modelNameEl.textContent = `æ¨¡å‹: ${config.model}`;
                currentModelEl.textContent = config.model;
                
                if (!config.has_api_key) {
                    showError('æœªé…ç½®APIå¯†é’¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            clearChatBtn.addEventListener('click', clearChat);
            
            // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // ç¦ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
            messageInput.disabled = true;
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ€è€ƒä¸­...';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessageToUI('user', message);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // æ·»åŠ AIæ¶ˆæ¯å ä½ç¬¦
            const aiMessageId = 'ai-' + Date.now();
            addMessageToUI('ai', '', aiMessageId);
            
            // å‘é€è¯·æ±‚
            try {
                currentStream = await streamAIResponse(message, aiMessageId);
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                updateAIMessage(aiMessageId, `<span class="error">è¯·æ±‚å¤±è´¥: ${error.message}</span>`);
            } finally {
                // æ¢å¤è¾“å…¥å’Œå‘é€æŒ‰é’®
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> å‘é€';
                messageInput.focus();
            }
        }

        // æµå¼è·å–AIå“åº”
        async function streamAIResponse(userMessage, messageId) {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
            chatHistory.push({ role: 'user', content: userMessage });
            
            // å‘èµ·æµå¼è¯·æ±‚
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: chatHistory.slice(-10) // å‘é€æœ€è¿‘10æ¡å†å²
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiResponse = '';
            
            // è¯»å–æµæ•°æ®
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);
                        
                        if (data === '[DONE]') {
                            // æµå¼ä¼ è¾“å®Œæˆ
                            chatHistory.push({ role: 'assistant', content: aiResponse });
                            return;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            
                            if (parsed.error) {
                                throw new Error(parsed.error);
                            }
                            
                            if (parsed.content) {
                                aiResponse += parsed.content;
                                updateAIMessage(messageId, aiResponse);
                            }
                        } catch (e) {
                            console.error('è§£ææµæ•°æ®å¤±è´¥:', e);
                        }
                    }
                }
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessageToUI(role, content, messageId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            if (messageId) {
                messageDiv.id = messageId;
            }
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <i class="fas fa-user"></i> <strong>ä½ </strong>
                    </div>
                    <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <i class="fas fa-robot"></i> <strong>AIåŠ©æ‰‹</strong>
                    </div>
                    <div class="message-content">${content}</div>
                `;
            }
            
            chatHistoryEl.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ›´æ–°AIæ¶ˆæ¯
        function updateAIMessage(messageId, content) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                const contentDiv = messageDiv.querySelector('.message-content');
                contentDiv.innerHTML = content.replace(/\n/g, '<br>');
                scrollToBottom();
            }
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ')) {
                // ä¸­æ­¢å½“å‰æµ
                if (currentStream) {
                    currentStream.cancel?.();
                }
                
                // æ¸…ç©ºå†å²
                chatHistory = [];
                
                // æ¸…ç©ºç•Œé¢ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
                const welcomeMessage = document.querySelector('.welcome-message');
                chatHistoryEl.innerHTML = '';
                if (welcomeMessage) {
                    chatHistoryEl.appendChild(welcomeMessage);
                }
                
                scrollToBottom();
            }
        }

        // å¤„ç†é”®ç›˜å¿«æ·é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            chatHistoryEl.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }
    </script>
</body>
</html>
