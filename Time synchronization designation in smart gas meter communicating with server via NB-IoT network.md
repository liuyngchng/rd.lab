<div align='center'><font size='6'>窄带物联网智能燃气表通信中的时钟同步方法设计</font></div>

<div align='center'><font size='6'>Time synchronization designation in smart gas meter communicating with server via NB-IoT network</font></div>

<div align='center'><font size='4'>AAA<sup>1</sup>, 刘永成<sup>1</sup>, CCC<sup>1</sup></font></div>

<div align='center'><font size='4'>（1. 昆仑数智科技有限责任公司，北京，102206）</font></div>

<div align='right'>中图分类号：TP311.1</div>

<div><font size='4'>&nbsp;&nbsp;&nbsp;&nbsp;<strong>摘&nbsp;&nbsp;要：</strong>在基于窄带物联网（Narrow Band Internet of Things, 简称 NB-IoT）的智能燃气表表具和远端数据采集系统进行远程通信时，需要对通信两端的系统进行系统时钟的同步，以达到表具采用采集系统时钟的目的。智能燃气表具中使用的 NB-IoT 模组虽具有厂商扩展的时间同步 AT 指令，但由于表具嵌入式系统、NB-IoT 模组型号以及通信运营商的的差异性，往往无法进行时钟服务器的统一接入、配置以及后期的统一运营。本文基于通用服务器的 NTP 时钟同步思想，设计了一种简单的基于时间戳误差计算的时钟同步方法，能够以统一的应用层协议方式，实现不同厂商表具、不同物联网模组按统一的方式通过 NB-IoT 网络实现网络时间同步。通过实验验证，物联网智能燃气表与信息采集系统服务器之间的时钟同步精度可达到 5ms 。</font></div>
<div><font size='4'>&nbsp;&nbsp;&nbsp;&nbsp;<strong>关键词：</strong>时钟同步;&nbsp;NB-IoT;&nbsp;窄带物联网;&nbsp;NTP;&nbsp;智能燃气表</font></div>

<div>&nbsp;&nbsp;<font size='4'><strong>Abstract: </strong> Time synchronization should to be done when smart gas meter communicates with remote data collecting system via NB-IoT network. The time synchronization AT command of NB-IoT module extended by manufacture is a possible way to be used, but the difference among gas meters in aspect of embeded system, NB-IoT module type and access of internet service provider let the way be difficult. In fact there is no uniform time synchrozaion channal can be used in such situation. A simplified time synchronization method was designed according to NTP, which could be used in communication between embeded system and general x86 system via NB-IoT with uniformed applicaion layer protocol. Time synchronization was implemented between smart gas meter and data collecting server, and experiments show that the time synchronizatio accuracy of the system can meet 5ms.</font></div>
<div>&nbsp;&nbsp;<font size='4'><strong>Keywords: </strong> time synchronization; NB-IoT; narrow band internet of things; NTP; network time protocol; smart gas meter</font></div>

# 引言

随着无线通信技术尤其是 5G 通信技术的快速发展，万物互联逐渐成为一种大的趋势，燃气领域中居民使用的传统基于插卡式 IC 卡、线下缴费的燃气表也在逐步向基于物联网、线上缴费的智能燃气表转变<sup>[<a href='#ref1'>1</a>, <a href='#ref2'>2</a>]</sup>。 智能燃气表是一种在燃气计量基表基础上新增了电子和通信模块的新型燃气表<sup>[<a href='#ref3'>3</a>]</sup>，目前逐步在民用和工业领域得到大规模应用。具备远程控制功能的物联网智能燃气表，能够在远端采集平台采集表端信息进行计费等业务，并支持从远端采集平台下发控制指令，实现了远程控制燃气表以及远程获取数据的功能。

物联网智能燃气表管理系统中的远端采集平台（以下简称采集平台）一般采用通用的互联网服务架构，以请求响应的模式通过通信运营商的 NB-IoT（Narrow Band Internet of Things, 窄带物联网技术）网络，实现与物联网智能燃气表的通信和控制<sup>[<a href='#ref4'>4</a>]</sup>，如图 1 所示。

<div align='center'>
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 180 288" width="15pc" height="24pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-07-15 05:27:57 +0000</dc:date></metadata><defs><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.99585" descent="-212.99744" font-weight="500"><font-face-src><font-face-name name="HelveticaNeue"/></font-face-src></font-face><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker_2" viewBox="-9 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M -8 0 L 0 3 L 0 -3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>Canvas 1</title><g><title>Layer 1</title><path d="M 22.625 210.73694 L 120.25 210.73694 C 124.66828 210.73694 128.25 214.31866 128.25 218.73694 L 128.25 258.98694 C 128.25 263.40522 124.66828 266.98694 120.25 266.98694 L 22.625 266.98694 C 18.206722 266.98694 14.625 263.40522 14.625 258.98694 L 14.625 218.73694 C 14.625 214.31866 18.206722 210.73694 22.625 210.73694 Z" fill="white"/><path d="M 22.625 210.73694 L 120.25 210.73694 C 124.66828 210.73694 128.25 214.31866 128.25 218.73694 L 128.25 258.98694 C 128.25 263.40522 124.66828 266.98694 120.25 266.98694 L 22.625 266.98694 C 18.206722 266.98694 14.625 263.40522 14.625 258.98694 L 14.625 218.73694 C 14.625 214.31866 18.206722 210.73694 22.625 210.73694 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(19.625 216.86194)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="27.8125" y="17" textLength="48">物联网</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="11.8125" y="39" textLength="80">智能燃气表</tspan></text><path d="M 22.625 110.350746 L 120.25 110.350746 C 124.66828 110.350746 128.25 113.93247 128.25 118.350746 L 128.25 158.60075 C 128.25 163.01902 124.66828 166.60075 120.25 166.60075 L 22.625 166.60075 C 18.206722 166.60075 14.625 163.01902 14.625 158.60075 L 14.625 118.350746 C 14.625 113.93247 18.206722 110.350746 22.625 110.350746 Z" fill="white"/><path d="M 22.625 110.350746 L 120.25 110.350746 C 124.66828 110.350746 128.25 113.93247 128.25 118.350746 L 128.25 158.60075 C 128.25 163.01902 124.66828 166.60075 120.25 166.60075 L 22.625 166.60075 C 18.206722 166.60075 14.625 163.01902 14.625 158.60075 L 14.625 118.350746 C 14.625 113.93247 18.206722 110.350746 22.625 110.350746 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(19.625 116.475746)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" fill="black" x="11.8125" y="17" textLength="80">通信运营商</tspan><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" fill="black" x="10.1885" y="39" textLength="51.248">NB-IoT</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" fill="black" x="61.4365" y="39" textLength="32">网络</tspan></text><path d="M 22.625 21.01306 L 120.25 21.01306 C 124.66828 21.01306 128.25 24.594782 128.25 29.01306 L 128.25 59.13806 C 128.25 63.556338 124.66828 67.13806 120.25 67.13806 L 22.625 67.13806 C 18.206722 67.13806 14.625 63.556338 14.625 59.13806 L 14.625 29.01306 C 14.625 24.594782 18.206722 21.01306 22.625 21.01306 Z" fill="white"/><path d="M 22.625 21.01306 L 120.25 21.01306 C 124.66828 21.01306 128.25 24.594782 128.25 29.01306 L 128.25 59.13806 C 128.25 63.556338 124.66828 67.13806 120.25 67.13806 L 22.625 67.13806 C 18.206722 67.13806 14.625 63.556338 14.625 59.13806 L 14.625 29.01306 C 14.625 24.594782 18.206722 21.01306 22.625 21.01306 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(19.625 33.07556)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="19.8125" y="17" textLength="64">采集平台</tspan></text><path d="M 71.873233 77.037195 L 72.004664 86.97948 L 71.85629 100.451347" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="71.4375" y1="176.50075" x2="71.4375" y2="200.83694" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(82.8125 178.7444)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" fill="black" x="0" y="17" textLength="80">上下行消息</tspan></text><text transform="translate(82.8125 79.744403)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="80">上下行消息</tspan></text></g></g></svg></div>
<center>图 1 物联网智能燃气表通信模式</center>

时钟同步是一个大型系统中其他所有业务的基础<sup>[<a href='#ref5'>5</a>, <a href='#ref6'>6</a>]</sup>，如图 1 所示，在采集平台和物联网智能燃气表进行通信和控制的过程中，需进行二者之间的时钟同步，建立二者通信的时钟基准。目前实现网络时钟同步的协议主要有 SNTP<sup>[<a href='#ref7'>7</a>]</sup>（Simple Network Time Protocol，简单网络时间协议）以及 SNTP 的升级版 NTP<sup>[<a href='#ref8'>8</a>]</sup>（Network Time Protocol，网络时间协议），还有IEEE 1588 Precision Clock Synchronization Protocol（ 即精密时间同步协议，简称 PTP 协议）<sup>[<a href='#ref9'>9</a>, <a href='#ref10'>10</a>]</sup>， 以上协议都需要底层的 TCP/IP 协议栈的支持，基于 MCU 的简单嵌入式系统直接使用这些协议需要额外的硬件支持<sup>[<a href='#ref11'>11</a>]</sup>。工业实践中，物联网智能燃气表一般采用自研的嵌入式软件系统<sup>[<a href='#ref1'>1</a>, <a href='#ref12'>12</a>]</sup>，同时在硬件上也使用了有别于采集系统通用计算机的硬件时钟，考虑到成本、制造工艺等因素及系统复杂度也尽量不采用额外的硬件。因此，一般以数据采集系统通用服务器的时钟作为基准，对物联网智能燃气表的时钟系统进行校准。行业实践中，有作者通过采用额外的硬件<sup>[<a href='#ref13'>13</a>]</sup>，通过 NTP 协议实现了表端嵌入式系统的时间同步，这种方法会对表具的制造生产产生额外的成本，同时也无法在现有的硬件基础上通过纯软件的方式实现升级，不利于系统改造。

#  时钟同步问题

当前民用燃气领域的工程现状是数据采集平台将其系统时间戳下发至物联网燃气表，由物联网燃气表根据时间戳对其时钟进行校正<sup>[<a href='#ref14'>14</a>]</sup>。这种时钟校正方法的优点是软件实现简单方便，能够满足基本的通信需求。其缺点是时钟校正精度为秒级，精度较低，受 NB-IoT 网络的通信延迟影响较大，因民用燃气业务较为简单，对于一般的民用燃气业务，这种误差不会产生较大影响，但若涉及到阶梯计费<sup>[<a href='#ref15'>15</a>]</sup>，则容易引起合同纠纷。若采用 NB-IoT模组自带的时钟同步功能，则由于不同模组接入的差异性以及不同运营商的后端时间服务器的差异性，对于燃气企业来说无法进行有效控制和统一运营。

在工业控制领域，智能计量、数据分析等都需要更精确的时钟<sup>[<a href='#ref12'>12</a>]</sup>，采用时间戳同步的简单时钟同步方法往往会对相应业务计算造成较大的误差，以如图 2 中的示例进行说明。

<div align='center'><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 288" width="30pc" height="24pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-07-15 05:46:15 +0000</dc:date></metadata><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="12" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>Canvas 4</title><g><title>Layer 1</title><line x1="20.25" y1="73.125" x2="320.95488" y2="73.125" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="20.25" y1="212.625" x2="320.95488" y2="212.625" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(25.25 31.375)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="128">采集系统单调时钟</tspan></text><text transform="translate(19.625 253)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="192">物联网智能燃气表单调时钟</tspan></text><text transform="translate(49.5 75.25)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="53" y1="64.029618" x2="53" y2="73.125" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="50.625" y1="203.52962" x2="50.625" y2="212.625" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(47.5 212.5)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><line x1="60.342403" y1="97.75" x2="97.948134" y2="187.86364" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="1,4"/><text transform="translate(96.521484 141.625)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".01" y="13" textLength="119.784">下发时间戳t1, 用时 t(fl</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="119.794" y="13" textLength="38.196">y time)</tspan></text><line x1="102.375" y1="203.52962" x2="102.375" y2="212.625" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(98.521484 212)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="42.264">t2 + t(fl</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="42.534" y="13" textLength="38.196">y time)</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="5.964" y="30" textLength="69.072">时间设置为t1</tspan></text><line x1="102.375" y1="64.029618" x2="102.375" y2="73.125" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(100.521484 75.25)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="39.876">t1 + t(fl</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="40.34" y="13" textLength="38.196">y time)</tspan></text></g></g></svg></div>

 <center>图 2 物联网智能燃气表简单时钟同步</center>

采集系统在 $t_1$  时刻（此时物联网智能燃气表的时钟为 $t_2$ 时刻）将时间戳 $t_1$ 下发，当物联网智能燃气表收到时间戳 $t_1$ 时，由于网络传输延迟，以及其他业务处理所消耗的时间，计算端到端的延迟时间为$t_{fly time}$，实际上表具应在 $t_2+t_{fly time}$ 时刻将其时间设定为 $t_1 + t_{fly time}$，然而  $t_{fly time}$ 对于表具是不可见的，也无法计算得出，同时  $t_{fly time}$ 受网络传输状况的影响较大，是一个随时间变化的数值。工程实践中， 表具在 $t_2+ t_{fly time}$ 时刻收到时间戳  $t_1$，直接将时间修正为 $t_1$，导致引入一个不确定的误差  $t_{fly time}$。同时，当物联网燃气表上的单调时钟快于采集系统单调时间，即 $t_2 > t_1$ 时, 一旦在时刻 $t_2+ t_{fly time}$ 将时间调整为 $t_1$，则可能回导致某些按照时间进行计算的逻辑出现“时间倒退”的现象，即当  $t_2 + t_{fly time}>t_1$，引起第三者视角从时间维度看到的业务产生混乱。

同时，工业领域内的燃气系统瞬时流量较大，在较小的时间内其某些计量的数值也较大，一个较小的时间误差会导致较大的计算误差。在实际的工程中，端到端的延迟包含有线网络的延迟和运营商无线通信网络的延迟两部分。有线网络的延迟的估， 按照北京到乌鲁木齐的公路距离 2753.7 km（$2.7537 \times 10^6$ m）计算网络光纤的长度，有线网络传输的物理延迟时间 $d$ 为: 
$$
\begin{align}
d&=\frac{2.7537 \times 10^6m }{3\times 10^8 m/s}=\frac{2.7537}{3}\times 10^{-2}s \\
&\approx 0.01s = 10ms\tag{1}
\end{align}
$$
考虑到其他通信设备的延迟时间，单程延迟可达到约 $ 30 ms ～ 100 ms$，实际的有线网络测得的网络延迟如图 3 所示，约为 33 ms。

```shell
ip addr | grep 11
    inet 11.10.36.*/26 brd 11.10.36.63 scope global ens160
[****@****tapp-1 ~]$ ping 11.54.82.121
PING 11.54.82.* (11.54.82.121) 56(84) bytes of data.
64 bytes from 11.54.82.121: icmp_seq=1 ttl=51 time=65.7 ms
64 bytes from 11.54.82.121: icmp_seq=2 ttl=51 time=65.7 ms
```

<center>图 3 有线网络延迟测量</center>

运营商无线通信网络的延迟部分， NB-IoT 的空口信道延迟基本在 350 ms 以上<sup>[<a href='#ref16'>16</a>, <a href='#ref17'>17</a>]</sup>。在实际的工程实践中，由于通信运营商的信息系统和燃气业务信息系统是两个独立的系统<sup>[<a href='#ref18'>18</a>]</sup>，两个系统之间还需要进行数据的互联互通，如图 1 所示， 通信运营商平台和数据采集平台之间的数据传输也会引入额外的端对端延迟。

工程实践中实际的 NB-IoT 网络端对端的通信延迟如图 4 所示，由于图 4 中的指令通信采用的是 HTTP 协议，可估算出采集平台端到表端的链路延迟为 $1s～2s$，即因为链路延迟引入的时间误差在秒级，即图 2 中端到端的传输时间 $t_{fly time}=1s～2s$ 。

![./pic/5.jpg](/home/rd/work/text/pic/5.jpg)

 <center>图 4 工程实践中的端对端通信延迟</center>

# 时钟同步设计

为解决图 2 中的的时钟误差问题，提升时钟同步的精度，参考 RFC 5905 Network Time Protocol （简称 NTP， 网络时间协议）<sup>[<a href='#ref8'>8</a>]</sup>，本文设计了一种智能燃气表嵌入式系统时钟同步方法，可以屏蔽不同的表具型号、不同的 NB-IoT 模组型号，以统一的应用层协议的方式实现时钟同步。考虑到实际实现的难度，忽略中间的链路，将端到端的系统进行抽象简化，嵌入式系统时钟同步方法如图 5 所示，以采集系统端的单调时钟为时钟基准进行时钟同步。

<div align='center'>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 288" width="30pc" height="24pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-07-15 05:35:59 +0000</dc:date></metadata><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="12" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>Canvas 2</title><g><title>Layer 1</title><line x1="20.25" y1="73.125" x2="320.95488" y2="73.125" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="20.25" y1="212.625" x2="320.95488" y2="212.625" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(25.25 31.375)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="128">采集系统端单调时钟</tspan></text><text transform="translate(17 235)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="192">物联网智能燃气表端单调时钟</tspan></text><text transform="translate(88.375 79.73047)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><line x1="93.375" y1="64.029618" x2="93.375" y2="73.125" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="50.625" y1="203.52962" x2="50.625" y2="212.625" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(48.5 212.5)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="51.625" y1="192.71429" x2="85.220467" y2="111.38061" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="1,4"/><text transform="translate(77 152.875)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="0" y="13" textLength="72">请求同步时钟</tspan></text><line x1="238.5" y1="203.52962" x2="238.5" y2="212.625" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(239 212.5)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t4</tspan></text><line x1="175.02148" y1="64.029618" x2="175.02148" y2="73.125" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(169.52148 79.73047)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t3</tspan></text><line x1="181.85714" y1="102.23047" x2="229.22763" y2="188.32622" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="1,4"/><text transform="translate(227.75 136.375)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="21.5" y="13" textLength="48">下发含有</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".458" y="30" textLength="90.084">t2, t3的同步消息</tspan></text></g></g></svg></div>
 <center>图 5 端到端的时钟同步设计</center>

如图 5 所示， 物联网智能燃气表在按照表端单调时钟系统记录 $t_1$ 时刻发起时钟同步，采集系统收到同步请求后，按照采集系统单调时钟系统记录收到的时刻为 $t_2$，在下发同步时钟消息中按照采集系统单调时钟记录时刻 $t_3$，当物联网智能燃气表收到同步消息时，按照表具单调时钟记录时刻 $t_4$。

按照图 3 中的计时系统计时后，则物联网燃气表可在表端计算获得整个通信过程中的网络传输时间 $t_{n}$：
$$
\begin{equation}
t_{n}=(t_4-t_1)-(t_3-t_2) \tag{2}
\end{equation}
$$
此处的网络传输时间 $t_{n}$ 为双向通信（一个通信往返）的网络传输时间，假定上下行的延迟时间是相同的，则可计算出单程网络传输时间，即图 2 中的 $t_{fly time}$：
$$
\begin{align}
t_{fly time} &= \frac{1}{2}t_{n}\\
&=\frac{1}{2}[(t_4-t_1)-(t_3-t_2)] \tag{3}
\end{align}
$$
如果实际场景中上下行的延迟时间不同，则公式（3）中的 $t_{fly time}$需要重新计算。

如图 5 所示，表端单调时钟的 $t_1$ 时间戳发送至采集系统后，采集系统按照其单调时钟系统记录的时间戳为 $t_2$ ，考虑公式（3）中的单程网络传输时间 $t_{fly time}$ ，此时准确的表端单调时钟时间戳为 $t_1+t_{fly time}$，则表端可计算其时钟系统和采集系统的时钟系统的时间误差 $t_{d}$：
$$
\begin{align}
t_{d}&=t_2-(t_1+t_{fly time})\\
&=t_2-t_1-\frac{1}{2}[(t_4-t_1)-(t_3-t_2)]\\
&=\frac{1}{2}[(t_2-t_1)-(t_4-t_3)]\tag{4}
\end{align}
$$
 得到了准确的时钟误差 $t_d$ 后，表端若在时刻 $t$ 调整其时钟，则时间调整如下：
$$
\begin{align}
t&=t+ t_d\\
&=t+\frac{1}{2}[(t_2-t_1)-(t_4-t_3)]\tag{5}
\end{align}
$$
考虑到物联网燃气表表端的一些业务逻辑中需获取时钟，时钟调整对业务逻辑的影响通过图 6 中的代码片段进行说明。

```c
long t1 = getTime();			// 步骤1: 获取系统时间 t1
do { b1(t1) };					// 步骤2: 处理业务 b1 
sys.time() = sys.time() + d3;	// 步骤3: 其他进程按照公式（4）中计算获取的 d3 调整系统时间
long t2 = getTime();			// 步骤4: 获取系统时间 t2
long b1_time_used = t2 - t1		// 步骤5: 计算业务 b1 的用时
do { b2(t2) };					// 步骤6: 处理业务 b2
```

<center> 图 6  表端业务逻辑处理代码片段</center>

考虑以下两种情况。

（1）$d_3$ > 0, 即表端单调时钟系统滞后于采集系统单调时钟系统，需向前步进时间单位 $d_3$。直接进行调整，可以观察到按照时间记录的业务 $b_1$ 的处理时间延长了时间 $\left|{d_3}\right|$ 。

（2）$d_3$ < 0, 即表端单调时钟系统超前于采集系统单调时钟系统，需要向后步进时间单位 $d_3$。直接进行调整，则可能会导致业务混乱。

例如，实际上，按照表具单调时钟系统（滴答时钟，时间只能向前）， $t_1$ 时刻发生 $b_1$ 业务，$t_2$ 时刻发生 $b_2$ 业务，$t_2$ 时刻晚于 $t_1$ 时刻。在 $b_1$ 发生后 $b_2$ 发生前，进行了表具时钟的调整（图 5 中的步骤 3 ），这样从表具的墙面时钟（记录的时间）来看， 业务 $b_2$ 的发生在时间上早于业务 $b_1$ ，出现了“时光倒流”，如图 7 所示。此时，以第三者视角看来，可能产生业务混乱。

<div align='center'><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 288" width="30pc" height="24pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-07-15 06:26:14 +0000</dc:date></metadata><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="12" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>Canvas 3</title><g><title>Layer 1</title><line x1="16.875" y1="92.34538" x2="317.57988" y2="92.34538" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(15.125 38.125)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="288">物联网智能燃气表单调时钟（滴答时钟）</tspan></text><text transform="translate(21.875 246.09538)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="288">物联网智能燃气表墙面时钟（记录时钟）</tspan></text><line x1="148.875" y1="83.25" x2="148.875" y2="92.34538" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(144.375 94.84538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="235.125" y1="83.25" x2="235.125" y2="92.34538" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(235.625 92.22038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><text transform="translate(142.375 117.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".08" y="13" textLength="63.84">b1 业务发生</tspan></text><text transform="translate(233.625 117.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".386" y="13" textLength="66.228">b2 业务发生</tspan></text><line x1="16.875" y1="192.47038" x2="317.57988" y2="192.47038" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="148.875" y1="183.375" x2="148.875" y2="192.47038" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(144.375 194.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="235.125" y1="183.375" x2="235.125" y2="192.47038" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(235.625 192.34538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><text transform="translate(144.375 218.09538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".08" y="13" textLength="63.84">b1 业务发生</tspan></text><text transform="translate(34.25 218.09538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".386" y="13" textLength="66.228">b2 业务发生</tspan></text><text transform="translate(31.75 194.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".21" y="13" textLength="50.58">tx=t2-|d3|</tspan></text><line x1="38.25" y1="183.375" x2="38.25" y2="192.47038" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/></g></g></svg></div>

 <center>图 7 “时光倒流”现象示意图</center>

为了避免出现 “时光倒流”的现象，表具应按照其实际时钟记录精度（例如 1ms），将需要调整的时钟误差 $d_3$ 分割成多个较小的单位，按照逐步逼近的方式，多次进行时钟调整。或者，考虑到表具嵌入式系统中的微控制器实际时间的控制程度<sup>[<a href='#ref19'>19</a>]</sup>，可以使其单调时钟系统的“滴答”变慢，最终实现平滑的时间过渡，避免出现图 7 中的问题，引起业务混乱。

# 实验验证

##  实验设计

实验验证环境的网络拓扑如图 8 所示。主机  h<sub>1</sub> 模拟数据采集平台， 主机 h<sub>2</sub> 模拟燃气表具，设定  h<sub>1</sub> 到   h<sub>2</sub>、h<sub>2</sub> 到 h<sub>1</sub> 的端到端网络传输延迟时间为 1s，即 h<sub>1</sub> -h<sub>2</sub> 的网络 RTT（Round Trip Time ，即往返时间）为 2s，h<sub>1</sub> -h<sub>2</sub> 的网络带宽设置为 200Kbps，模拟实际 NB-IoT 网络的端到端的延迟以及传输带宽<sup>[<a href='#ref20'>20</a>]</sup>。

<div align='center'>
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 324 180" width="27pc" height="15pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-09-08 02:44:35 +0000</dc:date></metadata><defs><font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.99585" descent="-212.99744" font-weight="500"><font-face-src><font-face-name name="HelveticaNeue"/></font-face-src></font-face><font-face font-family="Helvetica Neue" font-size="10" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.99585" descent="-212.99744" font-weight="500"><font-face-src><font-face-name name="HelveticaNeue"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>测试网络拓扑</title><rect fill="white" width="324" height="180"/><g><title>Layer 1</title><rect x="13.5" y="129.375" width="77.625" height="36" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(18.5 138.151)" fill="black"><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" x="26.5845" y="15" textLength="8.896">h</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="35.4805" y="15" textLength="5.56">1</tspan></text><rect x="232.875" y="129.375" width="77.625" height="36" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(237.875 138.151)" fill="black"><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" x="26.5845" y="15" textLength="8.896">h</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="35.4805" y="15" textLength="5.56">2</tspan></text><line x1="91.125" y1="147.375" x2="232.875" y2="147.375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(128.9375 116.375)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="1.725" y="11" textLength="20">RTT</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="21.725" y="11" textLength="38.55"> 2000ms</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x=".165" y="25" textLength="61.67">带宽200Kbps</tspan></text><rect x="123.9375" y="9" width="77.625" height="36" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(128.9375 17.776001)" fill="black"><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" x="26.5845" y="15" textLength="8.896">h</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="35.4805" y="15" textLength="5.56">3</tspan></text><path d="M 123.9375 27 L 116.9375 27 L 52.3125 27 L 52.3125 129.375 L 52.3125 122.375 L 52.3125 129.375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 201.5625 27 L 208.5625 27 L 271.6875 27 L 271.6875 129.375 L 271.6875 122.375 L 271.6875 129.375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(57.875 65.75)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="10.065" y="11" textLength="20">RTT</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="30.065" y="11" textLength="21.87"> 0.5 ms</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x=".2" y="25" textLength="61.6">带宽100Mbps</tspan></text><text transform="translate(203 65.75)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="10.065" y="11" textLength="20">RTT</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="30.065" y="11" textLength="21.87"> 0.5 ms</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x=".2" y="25" textLength="61.6">带宽100Mbps</tspan></text></g></g></svg>
</div>
<center>图 8 时钟同步实验网络拓扑示意图</center>

主机  h<sub>3</sub> 作为监控机器节点，实时获取节点 h<sub>1</sub> 和节点 h<sub>2</sub> 的系统时间，为了减少引入的时间误差，将 h<sub>3</sub> - h<sub>1</sub>、 h<sub>3</sub> - h<sub>2</sub> 之间的网络带宽设置为 100 Mbps，RTT 设置为 0.5 ms。  h<sub>1</sub>、 h<sub>2</sub> 、h<sub>3</sub> 3 个节点中的数据传输采用 HTTP 协议。

（1）按照简易时间戳下发的方法进行时钟同步，通过 h<sub>3</sub> 记录时钟同步后主机 h<sub>1</sub> 和 h<sub>2 </sub>的时钟差；

（2）按照本文设计的基于时间戳误差计算的时钟同步方法进行时钟同步，通过 h<sub>3</sub> 记录时钟同步后主机 h<sub>1</sub> 和 h<sub>2 </sub>的时间差，与（1）进行比较，查看时钟同步精度提升程度。

##  软件设计

本文设计的时钟同步为单向时钟同步方式，两端为服务端（数据采集平台端）和客户端（智能燃气表端），客户端将其时钟同步为服务端的时钟。

（1）智能燃气表端。智能燃气表端作为客户端，主动发起时钟同步请求，其软件流程设计如图 9 所示。
<div align='center'>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 432" width="30pc" height="36pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-09-07 03:10:01 +0000</dc:date></metadata><defs><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>时间同步客户端</title><rect fill="white" width="360" height="432"/><g><title>Layer 1</title><path d="M 135.892255 6.75 L 180.64225 6.75 C 185.06053 6.75 188.64225 10.331722 188.64225 14.75 L 188.64225 25.75 C 188.64225 30.168278 185.06053 33.75 180.64225 33.75 L 135.892255 33.75 C 131.47398 33.75 127.892255 30.168278 127.892255 25.75 L 127.892255 14.75 C 127.892255 10.331722 131.47398 6.75 135.892255 6.75 Z" fill="white"/><path d="M 135.892255 6.75 L 180.64225 6.75 C 185.06053 6.75 188.64225 10.331722 188.64225 14.75 L 188.64225 25.75 C 188.64225 30.168278 185.06053 33.75 180.64225 33.75 L 135.892255 33.75 C 131.47398 33.75 127.892255 30.168278 127.892255 25.75 L 127.892255 14.75 C 127.892255 10.331722 131.47398 6.75 135.892255 6.75 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(132.892255 9.25)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">开始</tspan></text><rect x="103.68026" y="47.082405" width="109.2183" height="42.75" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.68026 46.457405)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">获取当前</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">系统时间</tspan></text><rect x="103.68026" y="105.31254" width="109.2183" height="42.75" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.68026 104.68754)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">发送时钟</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">同步请求</tspan></text><line x1="158.26725" y1="33.75" x2="158.28941" y2="47.082405" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="158.28941" y1="89.832405" x2="158.28941" y2="105.31254" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="103.478867" y="164.41505" width="109.2183" height="42.75" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.47887 163.79005)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">等待接收</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">应答报文</tspan></text><line x1="158.28941" y1="148.06254" x2="158.08802" y2="164.41505" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 158.26725 220.5 L 236.65951 250.54167 L 158.26725 280.58333 L 79.875 250.54167 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(106.04091 227.94083)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="21.794191" y="17" textLength="64">报文接收</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="29.794191" y="39" textLength="48">成功？</tspan></text><line x1="158.08802" y1="207.16505" x2="158.26725" y2="220.5" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="103.76918" y="302.42395" width="109.2183" height="30.595564" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.76918 306.72174)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">计算时间误差</tspan></text><path d="M 236.65951 250.54167 L 248.55951 250.54167 L 258.64312 250.54167 L 258.64312 233.72814 L 258.74617 222.55579 L 258.74617 126.68754 L 224.79856 126.68754 L 222.79856 126.68754" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="158.26725" y1="280.58333" x2="158.37833" y2="302.42395" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="103.68026" y="353.45245" width="109.2183" height="30.595564" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.68026 357.75024)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">调整系统时间</tspan></text><line x1="158.37833" y1="333.01952" x2="158.28941" y2="353.45245" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(241.65951 231.625)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">否</tspan></text><text transform="translate(164.90529 281.92135)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">是</tspan></text><path d="M 136.28136 401.19358 L 181.03136 401.19358 C 185.44964 401.19358 189.03136 404.7753 189.03136 409.19358 L 189.03136 420.19358 C 189.03136 424.61186 185.44964 428.19358 181.03136 428.19358 L 136.28136 428.19358 C 131.86308 428.19358 128.28136 424.61186 128.28136 420.19358 L 128.28136 409.19358 C 128.28136 404.7753 131.86308 401.19358 136.28136 401.19358 Z" fill="white"/><path d="M 136.28136 401.19358 L 181.03136 401.19358 C 185.44964 401.19358 189.03136 404.7753 189.03136 409.19358 L 189.03136 420.19358 C 189.03136 424.61186 185.44964 428.19358 181.03136 428.19358 L 136.28136 428.19358 C 131.86308 428.19358 128.28136 424.61186 128.28136 420.19358 L 128.28136 409.19358 C 128.28136 404.7753 131.86308 401.19358 136.28136 401.19358 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(133.28136 403.69358)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">结束</tspan></text><line x1="158.28941" y1="384.04802" x2="158.65636" y2="401.19358" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/></g></g></svg>
</div>
<center>图 9 智能燃气表端软件流程设计示意图</center>

（2）数据采集平台端。 数据采集平台端作为服务端，响应客户端的时钟同步请求， 其软件流程设计如图 10 所示。
<div align='center'>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 504" width="30pc" height="42pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-09-07 03:10:01 +0000</dc:date></metadata><defs><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>时间同步服务端</title><rect fill="white" width="360" height="504"/><g><title>Layer 1</title><path d="M 140.97765 22.5 L 185.72765 22.5 C 190.14593 22.5 193.72765 26.081722 193.72765 30.5 L 193.72765 41.5 C 193.72765 45.918278 190.14593 49.5 185.72765 49.5 L 140.97765 49.5 C 136.55937 49.5 132.97765 45.918278 132.97765 41.5 L 132.97765 30.5 C 132.97765 26.081722 136.55937 22.5 140.97765 22.5 Z" fill="white"/><path d="M 140.97765 22.5 L 185.72765 22.5 C 190.14593 22.5 193.72765 26.081722 193.72765 30.5 L 193.72765 41.5 C 193.72765 45.918278 190.14593 49.5 185.72765 49.5 L 140.97765 49.5 C 136.55937 49.5 132.97765 45.918278 132.97765 41.5 L 132.97765 30.5 C 132.97765 26.081722 136.55937 22.5 140.97765 22.5 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(137.97765 25)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">开始</tspan></text><rect x="108.76566" y="66.5099" width="109.2183" height="32.67739" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.76566 71.848596)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">服务启动</tspan></text><rect x="108.76566" y="116.63985" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.76566 116.82228)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">时钟同步</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">请求监听</tspan></text><line x1="163.35265" y1="49.5" x2="163.37481" y2="66.5099" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="163.37481" y1="99.18729" x2="163.37481" y2="116.63985" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 163.32975 177.8849 L 229.90951 202.74752 L 163.32975 227.61015 L 96.75 202.74752 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(119.726534 191.25027)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="4.934816" y="17" textLength="80">请求到达？</tspan></text><rect x="108.585396" y="248.1745" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.585396 248.35693)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">记录接收请求</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="25.60915" y="39" textLength="48">时间戳</tspan></text><path d="M 229.90951 202.74752 L 241.80951 202.74752 L 264.49218 202.74752 L 264.49218 156.44196 L 264.49218 138.82228 L 229.88396 138.82228 L 227.88396 138.82228" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="163.32975" y1="227.61015" x2="163.19455" y2="248.1745" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="108.585396" y="311.7599" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.585396 311.94233)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">组装时钟同步</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="33.60915" y="39" textLength="32">报文</tspan></text><line x1="163.19455" y1="292.53936" x2="163.19455" y2="311.7599" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(246.7449 185.40965)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">否</tspan></text><text transform="translate(168.7104 228.3849)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">是</tspan></text><path d="M 140.77674 436.6349 L 185.52674 436.6349 C 189.94501 436.6349 193.52674 440.21662 193.52674 444.6349 L 193.52674 455.6349 C 193.52674 460.05318 189.94501 463.6349 185.52674 463.6349 L 140.77674 463.6349 C 136.35846 463.6349 132.77674 460.05318 132.77674 455.6349 L 132.77674 444.6349 C 132.77674 440.21662 136.35846 436.6349 140.77674 436.6349 Z" fill="white"/><path d="M 140.77674 436.6349 L 185.52674 436.6349 C 189.94501 436.6349 193.52674 440.21662 193.52674 444.6349 L 193.52674 455.6349 C 193.52674 460.05318 189.94501 463.6349 185.52674 463.6349 L 140.77674 463.6349 C 136.35846 463.6349 132.77674 460.05318 132.77674 455.6349 L 132.77674 444.6349 C 132.77674 440.21662 136.35846 436.6349 140.77674 436.6349 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(137.77674 439.1349)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">结束</tspan></text><line x1="163.19455" y1="356.12475" x2="163.21535" y2="374.7599" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="163.37481" y1="161.0047" x2="163.32975" y2="177.8849" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="108.606196" y="374.7599" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.606196 374.94233)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">发送时钟同步</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="33.60915" y="39" textLength="32">报文</tspan></text><line x1="163.21535" y1="419.12475" x2="163.15174" y2="436.6349" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/></g></g></svg>
</div>
<center>图 10  数据采集平台端的软件流程设计示意图</center>

## 实验结果

（1）采用简单的时间戳下发时钟同步方法进行时间同步后，通过 h<sub>3</sub> 采集 h<sub>1</sub>、h<sub>2</sub> 的系统时间进行比较，测试数据结果如表 1 所示。

<center>表 1  时间戳下发时钟同步实验数据</center>

| No   | 服务端（h<sub>1</sub>）时钟   | 客户端（h<sub>2</sub>）时钟   | 客户端（h<sub>2</sub>）相对于服务端（h<sub>1</sub>）的时钟误差（秒） |
| ---- | ----------------------------- | ----------------------------- | ------------------------------------------------------------ |
| 1    | 2022-09-13 01:03:33.756735148 | 2022-09-13 01:03:32.754114941 | -1.002620207                                                 |
| 2    | 2022-09-13 01:09:01.294784790 | 2022-09-13 01:09:00.291277131 | -1.003507659                                                 |
| 3    | 2022-09-13 01:10:14.622645045 | 2022-09-13 01:10:13.617068747 | -1.005576298                                                 |
| 4    | 2022-09-13 01:11:17.043157179 | 2022-09-13 01:11:16.039954676 | -1.003202503                                                 |
| 5    | 2022-09-13 01:12:58.703954615 | 2022-09-13 01:12:57.700283630 | -1.003670985                                                 |
| 6    | 2022-09-13 01:16:49.247449445 | 2022-09-13 01:16:48.245001725 | -1.002447720                                                 |
| 7    | 2022-09-13 01:18:09.648775703 | 2022-09-13 01:18:08.645985074 | -1.002790629                                                 |
| 8    | 2022-09-13 01:19:17.876719710 | 2022-09-13 01:19:16.872976216 | -1.003743494                                                 |
| 9    | 2022-09-13 01:20:24.088706231 | 2022-09-13 01:20:23.085022746 | -1.003683485                                                 |
| 10   | 2022-09-13 01:21:21.162689323 | 2022-09-13 01:21:20.160310589 | -1.002378734                                                 |

由表 1 可见， 同步后 h<sub>2</sub> 的时钟相对于 h<sub>1</sub>误差大约为 1s，即通过简单时间戳下发的同步方法，将至少引入一个网络传输延迟的时间。

（2）采用本文所设计的基于时间戳误差计算的时钟同步方法进行时钟同步。公式（3）中假定上下行通信的延迟时间是相同的。在本文中由于h<sub>1</sub>，h<sub>2</sub>的通信是基于 HTTP 进行的， HTTP 协议的底层协议 TCP 其上行通信建立连接时经历了3个网络传输延迟时间 <sup>[<a href='#ref21'>21</a>]</sup> ，下行通信延迟是网络传输延迟时间的 1 倍，所以 $t_{fly time}$ 应按照公式（6）计算：
$$
\begin{align}
t_{fly time} &= \frac{1}{4}t_{n}\\
&=\frac{1}{4}[(t_4-t_1)-(t_3-t_2)] \tag{6}
\end{align}
$$


依据公式（6）对网络延迟计算进行校正后，时间同步测试结果如表 2 所示。

<center>表 2  基于时间戳误差计算的时钟同步实验数据</center>

| No   | 服务端（h<sub>1</sub>）时钟   | 客户端（h<sub>2</sub>）时钟   | 客户端（h<sub>2</sub>）相对于服务端（h<sub>1</sub>）的时钟误差（秒） |
| ---- | ----------------------------- | ----------------------------- | ------------------------------------------------------------ |
| 1    | 2022-09-13 06:02:22.406935025 | 2022-09-13 06:02:22.403398931 | -0.003536094                                                 |
| 2    | 2022-09-13 06:04:00.703037142 | 2022-09-13 06:04:00.701504316 | -0.001532826                                                 |
| 3    | 2022-09-13 06:05:40.831728567 | 2022-09-13 06:05:40.828565694 | -0.003162873                                                 |
| 4    | 2022-09-13 06:07:26.219024048 | 2022-09-13 06:07:26.217180293 | -0.001843755                                                 |
| 5    | 2022-09-13 06:08:47.532350041 | 2022-09-13 06:08:47.528317173 | -0.004032868                                                 |
| 6    | 2022-09-13 06:09:44.996219566 | 2022-09-13 06:09:44.992700046 | -0.003519520                                                 |
| 7    | 2022-09-13 06:10:39.904512280 | 2022-09-13 06:10:39.901961137 | -0.002551143                                                 |
| 8    | 2022-09-13 06:11:30.578166514 | 2022-09-13 06:11:30.575262957 | -0.002903557                                                 |
| 9    | 2022-09-13 06:12:21.581112755 | 2022-09-13 06:12:21.579993858 | -0.001118897                                                 |
| 10   | 2022-09-13 06:13:11.332194301 | 2022-09-13 06:13:11.330426183 | -0.001768118                                                 |

通过表 2 所示的实验数据可以看出，采用基于时间戳误差计算的时钟同步，在实验环境下的时钟同步精度可以达到 5ms 。

# 总结

经过基于时间戳误差计算的时钟同步方法，可以在实验环境下的燃气表具端达到误差为5 ms 的同步精度，而采用简单的时间戳下发的方法，则至少会引入一个网络传输时间的误差，在本文中的网络条件下此误差为 1 s， 可见通过采用时间戳误差计算的时钟同步方法较简单时间戳下发同步方法，时钟同步精度由 1s 提升至 5 ms，时钟精度提升了99.5%。后续还需要在实际的智能燃气表具的嵌入式系统中实现如图 9 所示的软件逻辑，并与现有的自定义应用层报文协议及相应的通信指令相结合，进一步验证在实际终端和运营商通信网络环境中的时钟同步精度。同时，还需要考虑当时钟调整超过 1ms 时，在燃气表具端采用分阶段调整的方法，以防止引起如图 7 所示的业务逻辑问题。

# 参考文献

 <a name ='ref1'>[1]</a> 瞿浡麟. 试论 NB-IoT 物联网智能燃气表及其应用[C].中国燃气运营与安全研讨会（第十一届）暨中国土木工程学会燃气分会2021年学术年会论文集（上册）.2021: 691-696. DOI:10.26914/c.cnkihy.2021.061668.

<a name ='ref2'>[2]</a> 田小梦. ITU正式将NB-IoT技术纳入5G标准体系促进全球5G发展[J]. 通信世界, 2020(20): 29-30. DOI: 10.13571/j.cnki.cww.2020.20.014.

<a name ='ref3'>[3]</a> 刘兴伟, 陈婷婷, 法曙光. 城镇燃气计量仪表智能化标准发展探讨[J]. 煤气与热力,2022, 42(05): 44-46. DOI: 10.13608/j. cnki. 1000-4416.2022.05.018.

<a name ='ref4'>[4]</a> 郑红立,刘航,胡洋.NB-IoT技术在物联网智能燃气表领域的应用与推广[J]. 城市燃气,2021(08):6-11.

<a name ='ref5'>[5]</a> Bo Xue, Zhitian Li, Pengyu Lei, Yingzi Wang, Xudong Zou. Wicsync: A wireless multi-node clock synchronization solution based on optimized UWB two-way clock synchronization protocol[J], Measurement,2021(183).

<a name ='ref6'>[6]</a> Yamamoto Koutarou, Fukuhara Akihiro, Nishi Hiroaki. Hardware Implementation of MQTT Broker and Precise Time Synchronization Using IoT Devices[J], IEEJ Transactions on Electrical and Electronic Engineering, 2021, 17(2): 209-217.DOI:10.1002/TEE.23511.

<a name ='ref7'>[7]</a> Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI (RFC 2030), https://www.rfc-editor.org/rfc/rfc4330. 

<a name ='ref8'>[8]</a> Network Time Protocol Version 4: Protocol and Algorithms Specification (RFC 5905), https://datatracker.ietf.org/doc/rfc5905/.

<a name ='ref9'>[9]</a> 孙建鹏,刘欣,洪应平,何鑫,熊继军.基于DP83640的以太网时钟同步方法设计[J].电子学报,2021,49(05):1033-1040.

<a name ='ref10'>[10]</a>  Nagra Aamir Sohail, Allahi Irfan, Pasha Muhammad etc. Design and FPGA based Implementation of IEEE 1588 Precision Time Protocol for Synchronisation in Distributed IoT Applications[J]. Australian Journal of Electrical and Electronics Engineering, 2022, 19(1): 31-39. DOI: 10.1080/1448837X.2021.2013407.

<a name ='ref11'>[11]</a> 凤良山,李俊.一种域控制器片内及片外时间同步的方法[J]. 汽车实用技术, 2022,47(01): 61-64. DOI: 10.16638/j.cnki.1671-7988.2022.001.014.

<a name ='ref12'>[12]</a> 胡莽. NB-IoT 无线远传智能燃气表的设计与研究[C]//.中国燃气运营与安全研讨会（第十届）暨中国土木工程学会燃气分会2019年学术年会论文集（中册）.2019: 194-198. DOI: 10.26914/c.cnkihy.2019.021995.

<a name ='ref13'>[13]</a> 肖蕾,崔建峰.基于 NTP 协议的物联网时间同步设备的设计与实现[J]. 邵阳学院学报(自然科学版), 2016,13(03): 46-51.

<a name ='ref14'>[14]</a> 王照伟,曾鹏,于海斌.工业物联网环境下的时间同步技术分析[J]. 中兴通讯技术:1-8 [2022-09-05]. http://kns.cnki.net/kcms/detail/34.1228.TN.20190131.1438.010.html.

<a name ='ref15'>[15]</a> 邵泽华.物联网智能燃气表实施阶梯气价计费的途径[J]. 煤气与热力, 2020, 40(06): 25-26+46. DOI: 10.13608/j.cnki.1000-4416.2020.06.017.

<a name ='ref16'>[16]</a> 刘哲,曾伟,蔡凯.NB-IoT网络指标体系研究与应用[J]. 邮电设计技术, 2020(12): 56-60.

<a name ='ref17'>[17]</a> 杨观止,陈鹏飞,崔新凯,侯维岩.NB-IoT综述及性能测试[J]. 计算机工程, 2020, 46(01): 1-14.DOI: 10.19678/j.issn.1000-3428.0055006.

<a name ='ref18'>[18]</a> 邵泽华,张磊.智能燃气表物联网系统设计[J]. 物联网技术, 2021,11(06):55-57+61.DOI:10.16667/j.issn.2095-1302.2021.06.016.

<a name ='ref19'>[19]</a> 吴天强,叶敏,朱剑,潘超.单片机系统实时时钟日差补偿的算法设计[J].科技风,2019(34):10-11.DOI:10.19392/j.cnki.1671-7341.201934010.

<a name ='ref20'>[20]</a> 邹玉龙,丁晓进,王全全.NB-IoT关键技术及应用前景[J]. 中兴通讯技术, 2017, 23(01): 43-46.

<a name ='ref21'>[21]</a> 陈昱琦.网络安全之TCP/IP协议[J].科技风, 2021(16): 77-78.DOI:10.19392/j.cnki.1671-7341.202116037.



<div>通信作者介绍：刘永成，男，1983年11月生，工学硕士研究生。研究方向为计算机网络通信，网络仿真. E-mail： liuyngchng@163.com </div>
