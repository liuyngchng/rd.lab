<div align='center'><font size='5'>窄带物联网智能燃气表通信中的时钟同步方法设计</font></div>

<div align='center'><font size='4'>刘永成<sup>1</sup></font></div>

<div align='center'><font size='4'>（1. 昆仑数智科技有限责任公司，北京，102206）</font></div>

<div align='right'>中图分类号：TP311.1</div>

<div><font size='3'>&nbsp;&nbsp;&nbsp;&nbsp;<strong>摘&nbsp;&nbsp;要：</strong>在基于窄带物联网（Narrow Band Internet of Things, 简称 NB-IoT）的智能燃气表表具和远端数据采集系统进行远程通信时，需要对通信两端的系统进行系统时钟的同步，以达到表具采用采集系统时钟的目的。智能燃气表具中使用的 NB-IoT 模组虽具有厂商扩展的时间同步 AT 指令，但由于表具嵌入式系统、NB-IoT 模组型号以及通信运营商的差异性，往往无法进行时钟服务器的统一接入、配置以及后期的统一运营。本文基于通用服务器的 NTP 时钟同步思想，设计了一种基于时间戳计算网络传输时延的时钟同步方法，燃气企业能够以统一的应用层协议方式使不同厂商的表具、不同的物联网模组按统一的方式通过 NB-IoT 网络实现网络时钟同步。通过实验验证，物联网智能燃气表与信息采集系统服务器之间的时钟同步精度可达到 5ms 。</font></div>
<div><font size='3'>&nbsp;&nbsp;&nbsp;&nbsp;<strong>关键词：</strong>时钟同步；NB-IoT；窄带物联网；NTP；智能燃气表</font></div>

<div align='center'><font size='5'>Time synchronization design for smart gas meter communicating with server via NB-IoT network</font></div>

<div align='center'><font size='4'>Liu YongCheng<sup>1</sup></font></div>

<div align='center'><font size='4'>（1. Kunlun Digital Technology Co. Ltd.，Beijing，102206）</font></div>

<div>&nbsp;&nbsp;<font size='3'><strong>Abstract: </strong> Time synchronization should to be done when smart gas meter communicates with remote data collecting system via NB-IoT network. The time synchronization AT command of NB-IoT module extended by manufacture was a possible way to be used, but the difference among gas meters in aspect of embedded system, NB-IoT module type and access of internet service provider let the way be difficult. In fact there was no uniform time synchronization channel could be used in such situation. A simplified time synchronization method was designed according to NTP, which could be used in communication between embedded system and general X86 system via NB-IoT with uniformed application layer protocol self-defined by gas suppliers. Time synchronization was implemented between smart gas meter and data collecting server, and experiments shew that the time synchronization accuracy of the system can meet 5ms.</font></div>
<div>&nbsp;&nbsp;<font size='3'><strong>Keywords: </strong> time synchronization; NB-IoT; narrow band internet of things; NTP; network time protocol; smart gas meter</font></div>

# 引言

​      随着无线通信技术尤其是 5G 通信技术的快速发展，万物互联逐渐成为一种大的趋势，燃气领域中居民使用的传统基于插卡式 IC 卡、线下缴费的燃气表也在逐步向基于物联网、线上缴费的智能燃气表转变<sup>[<a href='#ref1'>1</a>, <a href='#ref2'>2</a>]</sup>。 智能燃气表是一种在燃气计量基表基础上新增了电子和通信模块的新型燃气表<sup>[<a href='#ref3'>3</a>]</sup>，目前逐步在民用和工业领域得到大规模应用。具备远程控制功能的物联网智能燃气表，使燃气企业具备了在远端数据采集平台采集表端计量信息从而进行计费等业务的能力，并支持从远端采集平台下发控制指令，实现了远程控制燃气表以及远程获取数据的功能。

物联网智能燃气表管理系统中的远端采集平台（以下简称采集平台）一般采用通用的互联网服务架构，以请求响应的模式通过通信运营商的 NB-IoT（Narrow Band Internet of Things, 窄带物联网技术）网络，实现与物联网智能燃气表的通信和进行相应的控制<sup>[<a href='#ref4'>4</a>]</sup>，如图 1 所示。

<div align='center'>
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 226.77165 283.46457" width="226.77165pt" height="283.46457pt" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-10-21 07:18:13 +0000</dc:date></metadata><defs><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.99585" descent="-212.99744" font-weight="500"><font-face-src><font-face-name name="HelveticaNeue"/></font-face-src></font-face><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker_2" viewBox="-9 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M -8 0 L 0 3 L 0 -3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>通信模式</title><g><title>Layer 1</title><path d="M 50.519685 206.73175 L 148.144685 206.73175 C 152.56296 206.73175 156.14469 210.31348 156.14469 214.73175 L 156.14469 254.98175 C 156.14469 259.40003 152.56296 262.98175 148.144685 262.98175 L 50.519685 262.98175 C 46.101407 262.98175 42.519685 259.40003 42.519685 254.98175 L 42.519685 214.73175 C 42.519685 210.31348 46.101407 206.73175 50.519685 206.73175 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(47.519685 212.85675)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="27.8125" y="17" textLength="48">物联网</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="11.8125" y="39" textLength="80">智能燃气表</tspan></text><path d="M 50.519685 106.34556 L 148.144685 106.34556 C 152.56296 106.34556 156.14469 109.92728 156.14469 114.34556 L 156.14469 154.59556 C 156.14469 159.01384 152.56296 162.59556 148.144685 162.59556 L 50.519685 162.59556 C 46.101407 162.59556 42.519685 159.01384 42.519685 154.59556 L 42.519685 114.34556 C 42.519685 109.92728 46.101407 106.34556 50.519685 106.34556 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(47.519685 112.47056)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="11.8125" y="17" textLength="80">通信运营商</tspan><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" x="10.1885" y="39" textLength="51.248">NB-IoT</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="61.4365" y="39" textLength="32">网络</tspan></text><path d="M 50.519685 17.007874 L 148.144685 17.007874 C 152.56296 17.007874 156.14469 20.589596 156.14469 25.007874 L 156.14469 55.132874 C 156.14469 59.551152 152.56296 63.132874 148.144685 63.132874 L 50.519685 63.132874 C 46.101407 63.132874 42.519685 59.551152 42.519685 55.132874 L 42.519685 25.007874 C 42.519685 20.589596 46.101407 17.007874 50.519685 17.007874 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(47.519685 29.070374)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="19.8125" y="17" textLength="64">采集平台</tspan></text><path d="M 99.76792 73.03201 L 99.89935 82.97429 L 99.750975 96.44616" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="99.332185" y1="172.49556" x2="99.332185" y2="196.83175" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(110.707185 174.73922)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="80">上下行消息</tspan></text><text transform="translate(110.707185 75.739217)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="80">上下行消息</tspan></text></g></g></svg>
</div>
<center>图 1 物联网智能燃气表通信模式</center>
时钟同步是一个大型系统中其他所有业务的基础<sup>[<a href='#ref5'>5</a>, <a href='#ref6'>6</a>]</sup>，如图 1 所示，在采集平台和物联网智能燃气表进行通信和进行相应控制的过程中，需进行二者之间的时钟同步，建立二者通信的时钟基准。目前实现网络时钟同步的协议主要有 SNTP<sup>[<a href='#ref7'>7</a>]</sup>（Simple Network Time Protocol，简单网络时间协议）以及 SNTP 的升级版 NTP<sup>[<a href='#ref8'>8</a>]</sup>（Network Time Protocol，网络时间协议），还有IEEE 1588 Precision Clock Synchronization Protocol（ 即精密时间同步协议，简称 PTP 协议）<sup>[<a href='#ref9'>9</a>, <a href='#ref10'>10</a>]</sup>， 以上协议都需要底层的 TCP/IP 协议栈的支持，基于 MCU 的简单嵌入式系统直接使用这些协议需要额外的硬件支持<sup>[<a href='#ref11'>11</a>]</sup>。工业实践中，物联网智能燃气表一般采用自研的嵌入式软件系统<sup>[<a href='#ref1'>1</a>, <a href='#ref12'>12</a>]</sup>，同时在硬件上也使用了有别于采集系统通用计算机的硬件时钟，考虑到成本、制造工艺等因素及系统复杂度也尽量不采用额外的硬件。因此，一般以数据采集系统通用服务器的时钟作为基准，对物联网智能燃气表的时钟系统进行校准。行业实践中，有作者通过采用额外的硬件<sup>[<a href='#ref13'>13</a>]</sup>，通过 NTP 协议实现了表端嵌入式系统的时间同步，这种方法会对表具的制造生产产生额外的成本，同时也无法在现有的硬件基础上通过纯软件的方式实现升级，不利于系统改造。目前部分 NB-IoT 通信模组厂商提供了扩展的 AT 指令进行 NTP 时间同步，然而由于表具嵌入式软件、模组以及通信运营商平台之间的差异性，以及网络环境安全管控等因素，燃气企业很难统一对不同的表具配置统一的 NTP 服务器。

#  时钟同步问题

当前民用燃气领域的现状是，燃气企业通过数据采集平台将其系统时钟下发至物联网燃气表，由物联网燃气表根据时间戳对表具端的时钟进行校正<sup>[<a href='#ref14'>14</a>]</sup>。这种时钟校准方法的优点是软件实现相对简单，能够满足基本的通信时钟同步需求。其缺点是时钟校准精度为秒级，同时受 NB-IoT 网络的通信延迟影响较大，因民用燃气业务较为简单，对于一般的民用燃气业务，这种误差不会产生较大影响，但若涉及到阶梯计费<sup>[<a href='#ref15'>15</a>]</sup>，则容易引起合同纠纷。

在工业控制领域，智能计量、数据分析等都需要更精确的时钟<sup>[<a href='#ref12'>12</a>]</sup>，采用时间戳同步的简单时钟同步方法往往会对相应业务计算造成较大的误差，以如图 2 中的示例进行说明。

<div align='center'><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 288" width="30pc" height="24pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-07-15 05:46:15 +0000</dc:date></metadata><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="12" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>Canvas 4</title><g><title>Layer 1</title><line x1="20.25" y1="73.125" x2="320.95488" y2="73.125" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="20.25" y1="212.625" x2="320.95488" y2="212.625" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(25.25 31.375)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="128">采集系统单调时钟</tspan></text><text transform="translate(19.625 253)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="192">物联网智能燃气表单调时钟</tspan></text><text transform="translate(49.5 75.25)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="53" y1="64.029618" x2="53" y2="73.125" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="50.625" y1="203.52962" x2="50.625" y2="212.625" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(47.5 212.5)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><line x1="60.342403" y1="97.75" x2="97.948134" y2="187.86364" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="1,4"/><text transform="translate(96.521484 141.625)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".01" y="13" textLength="119.784">下发时间戳t1, 用时 t(fl</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="119.794" y="13" textLength="38.196">y time)</tspan></text><line x1="102.375" y1="203.52962" x2="102.375" y2="212.625" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(98.521484 212)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="42.264">t2 + t(fl</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="42.534" y="13" textLength="38.196">y time)</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="5.964" y="30" textLength="69.072">时间设置为t1</tspan></text><line x1="102.375" y1="64.029618" x2="102.375" y2="73.125" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(100.521484 75.25)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="39.876">t1 + t(fl</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="40.34" y="13" textLength="38.196">y time)</tspan></text></g></g></svg></div>

 <center>图 2 物联网智能燃气表简单时钟同步</center>

采集系统在 $t_1$  时刻（此时物联网智能燃气表的时钟为 $t_2$ 时刻）将系统时钟（时间戳 $t_1$ ）下发，当物联网智能燃气表收到时间戳 $t_1$ 时，考虑到网络传输延迟，以及其他业务处理所消耗的时间，端到端的延迟时间计为 $t_{fly time}$，表具应在 $t_2+t_{fly time}$ 时刻应将其时钟设定为 $t_1 + t_{fly time}$，然而  $t_{fly time}$ 对于表具是不可见的，也无法计算得出，同时  $t_{fly time}$ 受网络传输状况的影响较大，是一个随时间变化的数值。工程实践中，表具在 $t_2+ t_{fly time}$ 时刻收到时间戳  $t_1$，直接将时间修正为 $t_1$，导致引入一个不确定的误差  $t_{fly time}$。同时，当物联网燃气表上的单调时钟快于采集系统单调时钟，即 $t_2 > t_1$ 时，一旦在时刻 $t_2+ t_{fly time}$ 将时间调整为 $t_1$，则可能会导致某些按照时间进行计算的逻辑出现“时间倒退”的现象，即当  $t_2 + t_{fly time}>t_1$，引起第三者视角从时间维度看到的业务产生混乱。

同时，工业领域内的燃气系统瞬时流量较大，在较小的时间内其某些计量的数值也较大，一个较小的时间误差会导致较大的计算误差。在实际的工程中，端到端的延迟包含有线网络的延迟和通信运营商无线通信网络的延迟两部分。有线网络的延迟， 按照北京到乌鲁木齐的公路距离 2753.7 km 计算网络光纤的长度，有线网络传输的物理延迟时间 $d$ 为: 
$$
\begin{align}
d&=\frac{2.7537 \times 10^6m }{3\times 10^8 m/s}=\frac{2.7537}{3}\times 10^{-2}s \\
&\approx 0.01s = 10ms\tag{1}
\end{align}
$$
考虑到其他通信设备的延迟时间，单程延迟可达到约 $ 30 ms ～ 100 ms$，实际测得的北京数据中心和克拉玛依数据中心有线网络延迟如图 3 所示，约为 33 ms。

```shell
ip addr | grep 11
    inet 11.10.36.*/26 brd 11.10.36.63 scope global ens160
[****@****tapp-1 ~]$ ping 11.54.82.121
PING 11.54.82.* (11.54.82.121) 56(84) bytes of data.
64 bytes from 11.54.82.121: icmp_seq=1 ttl=51 time=65.7 ms
64 bytes from 11.54.82.121: icmp_seq=2 ttl=51 time=65.7 ms
```

<center>图 3 有线网络延迟测量</center>

通信运营商无线通信网络的延迟部分， NB-IoT 的空口信道延迟基本在 350 ms 以上<sup>[<a href='#ref16'>16</a>, <a href='#ref17'>17</a>]</sup>。在实际的工程实践中，由于通信运营商的信息系统和燃气业务信息系统是两个独立的系统<sup>[<a href='#ref18'>18</a>]</sup>，属于不同的域，两个域之间还需要进行数据的互联互通，如图 1 所示， 跨域数据传输也会引入额外的端对端延迟。

工程实践中实际的 NB-IoT 网络端对端的通信延迟如图 4 所示，由于图 4 中的指令通信采用的是 HTTP 协议，可估算出采集平台端到表端的网络链路延迟为 $1s～2s$，即因为链路延迟引入的时间误差在秒级，即图 2 中端到端的传输时间 $t_{fly time}=1s～2s$ 。

![./pic/5.jpg](/home/rd/work/text/pic/5.jpg)

 <center>图 4 工程实践中的端对端通信延迟</center>

# 时钟同步设计

为解决图 2 中的的时钟误差问题，提升时钟同步的精度，参考 RFC 5905 Network Time Protocol （简称 NTP， 网络时间协议）<sup>[<a href='#ref8'>8</a>]</sup>，本文设计了一种智能燃气表嵌入式系统时钟同步方法，可以屏蔽不同的表具型号、不同的 NB-IoT 模组型号，以统一的应用层协议的方式实现时钟同步，系统架构如图5 所示。

<div align='center'>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 439.37008 260.7874" width="439.37008pt" height="260.7874pt" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-10-10 03:16:24 +0000</dc:date></metadata><defs><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 8 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="80" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="bold"><font-face-src><font-face-name name="PingFangSC-Semibold"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="Helvetica Neue" font-size="10" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.99585" descent="-212.99744" font-weight="500"><font-face-src><font-face-name name="HelveticaNeue"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="12" panose-1="2 11 8 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="80" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="bold"><font-face-src><font-face-name name="PingFangSC-Semibold"/></font-face-src></font-face><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker_2" viewBox="-9 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M -8 0 L 0 3 L 0 -3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="Helvetica Neue" font-size="12" panose-1="2 0 8 3 0 0 0 9 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="975.0061" descent="-216.99524" font-weight="bold"><font-face-src><font-face-name name="HelveticaNeue-Bold"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>系统架构</title><g><title>Layer 1</title><path d="M 229.92949 153.40551 L 417.88888 153.40551 C 422.30716 153.40551 425.88888 156.987235 425.88888 161.40551 L 425.88888 243.20079 C 425.88888 247.61907 422.30716 251.20079 417.88888 251.20079 L 229.92949 251.20079 C 225.51121 251.20079 221.92949 247.61907 221.92949 243.20079 L 221.92949 161.40551 C 221.92949 156.987235 225.51121 153.40551 229.92949 153.40551 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="4,4"/><text transform="translate(226.92949 232.70079)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="bold" x="26.979696" y="11" textLength="140">城镇小区居民物联网智能燃气表</tspan></text><path d="M 302.0366 164.03182 L 345.78177 164.03182 C 350.20005 164.03182 353.78177 167.61354 353.78177 172.03182 L 353.78177 186.87116 C 353.78177 191.28944 350.20005 194.87116 345.78177 194.87116 L 302.0366 194.87116 C 297.61832 194.87116 294.0366 191.28944 294.0366 186.87116 L 294.0366 172.03182 C 294.0366 167.61354 297.61832 164.03182 302.0366 164.03182 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(299.0366 172.45149)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="6.2025866" y="11" textLength="37.34">燃气表 1</tspan></text><path d="M 295.6171 91.94384 L 352.20127 91.94384 C 356.61955 91.94384 360.20127 95.525564 360.20127 99.94384 L 360.20127 121.36351 C 360.20127 125.78179 356.61955 129.36351 352.20127 129.36351 L 295.6171 129.36351 C 291.19882 129.36351 287.6171 125.78179 287.6171 121.36351 L 287.6171 99.94384 C 287.6171 95.525564 291.19882 91.94384 295.6171 91.94384 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(292.6171 97.51368)" fill="black"><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="15.277087" y="10" textLength="34.81">NB-IoT </tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="11.292087" y="23.279999" textLength="40">通信网络</tspan></text><path d="M 13.669291 3.1692914 L 201.62868 3.1692914 C 206.04696 3.1692914 209.62868 6.7510134 209.62868 11.1692914 L 209.62868 250.2874 C 209.62868 254.70568 206.04696 258.2874 201.62868 258.2874 L 13.669291 258.2874 C 9.2510134 258.2874 5.6692914 254.70568 5.6692914 250.2874 L 5.6692914 11.1692914 C 5.6692914 6.7510134 9.2510134 3.1692914 13.669291 3.1692914 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(10.6692914 8.1692914)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="bold" x="36.979696" y="13" textLength="120">燃气企业数据采集平台</tspan></text><line x1="323.90918" y1="139.26351" x2="323.90918" y2="154.13182" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(147.11744 49.7126)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="5" y="11" textLength="40">燃气企业</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="10" y="25" textLength="30">自定义</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="39" textLength="50">应用层协议</tspan></text><path d="M 66.70599 192.01003 L 148.74044 192.01003 C 153.15872 192.01003 156.74044 195.59176 156.74044 200.01003 L 156.74044 221.4297 C 156.74044 225.84798 153.15872 229.4297 148.74044 229.4297 L 66.70599 229.4297 C 62.287712 229.4297 58.70599 225.84798 58.70599 221.4297 L 58.70599 200.01003 C 58.70599 195.59176 62.287712 192.01003 66.70599 192.01003 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(63.70599 196.71987)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="29.017224" y="11" textLength="30">局域网</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="19.117224" y="25" textLength="49.8">NTP服务器</tspan></text><path d="M 22.442025 112.4202 L 60.63449 112.4202 C 65.052768 112.4202 68.63449 116.00192 68.63449 120.4202 L 68.63449 137.4202 C 68.63449 141.83848 65.052768 145.4202 60.63449 145.4202 L 22.442025 145.4202 C 18.023747 145.4202 14.442025 141.83848 14.442025 137.4202 L 14.442025 120.4202 C 14.442025 116.00192 18.023747 112.4202 22.442025 112.4202 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(19.442025 121.9202)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="3.4262324" y="11" textLength="37.34">服务器 1</tspan></text><path d="M 155.92497 112.4202 L 194.11744 112.4202 C 198.53572 112.4202 202.11744 116.00192 202.11744 120.4202 L 202.11744 137.4202 C 202.11744 141.83848 198.53572 145.4202 194.11744 145.4202 L 155.92497 145.4202 C 151.5067 145.4202 147.924975 141.83848 147.924975 137.4202 L 147.924975 120.4202 C 147.924975 116.00192 151.5067 112.4202 155.92497 112.4202 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(152.924975 121.9202)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="2.6362324" y="11" textLength="38.92">服务器 n</tspan></text><line x1="129.40592" y1="184.36488" x2="155.15657" y2="153.065355" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="86.357754" y1="184.31375" x2="61.115717" y2="153.11648" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 16.482379 175.12804 L 198.41329 175.12804 C 202.83156 175.12804 206.41329 171.54632 206.41329 167.12804 L 206.41329 104.7126 C 206.41329 100.29432 202.83156 96.7126 198.41329 96.7126 L 16.482379 96.7126 C 12.064101 96.7126 8.4823793 100.29432 8.4823793 104.7126 L 8.4823793 167.12804 C 8.4823793 171.54632 12.064101 175.12804 16.482379 175.12804 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="4,4"/><text transform="translate(13.482379 156.62804)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="bold" x="0" y="11" textLength="80">数据采集服务集群</tspan></text><path d="M 88.62698 112.4202 L 126.81945 112.4202 C 131.237725 112.4202 134.81945 116.00192 134.81945 120.4202 L 134.81945 137.4202 C 134.81945 141.83848 131.237725 145.4202 126.81945 145.4202 L 88.62698 145.4202 C 84.208704 145.4202 80.62698 141.83848 80.62698 137.4202 L 80.62698 120.4202 C 80.62698 116.00192 84.208704 112.4202 88.62698 112.4202 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(85.62698 121.9202)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="2.4312324" y="11" textLength="39.33">服务器 2</tspan></text><line x1="107.723215" y1="182.11003" x2="107.723215" y2="155.3202" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 85.723215 29.719488 L 129.723215 29.719488 C 134.14149 29.719488 137.723215 33.30121 137.723215 37.719488 L 137.723215 54.719488 C 137.723215 59.137766 134.14149 62.71949 129.723215 62.71949 L 85.723215 62.71949 C 81.304937 62.71949 77.723215 59.137766 77.723215 54.719488 L 77.723215 37.719488 C 77.723215 33.30121 81.304937 29.719488 85.723215 29.719488 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(82.723215 39.219488)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="50">广域网网关</tspan></text><text transform="translate(136.46518 117.9202)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">…</tspan></text><line x1="60.928994" y1="104.69071" x2="88.33248" y2="70.448977" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="107.723215" y1="102.5202" x2="107.723215" y2="72.61949" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="155.34561" y1="104.741384" x2="127.39881" y2="70.398304" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="147.623215" y1="46.219488" x2="284.00918" y2="46.219488" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(230.06398 138.562996)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="5" y="11" textLength="40">燃气企业</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="10" y="25" textLength="30">自定义</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="39" textLength="50">应用层协议</tspan></text><path d="M 240.3096 198.59036 L 284.05478 198.59036 C 288.47306 198.59036 292.05478 202.17209 292.05478 206.59036 L 292.05478 221.4297 C 292.05478 225.84798 288.47306 229.4297 284.05478 229.4297 L 240.3096 229.4297 C 235.89133 229.4297 232.3096 225.84798 232.3096 221.4297 L 232.3096 206.59036 C 232.3096 202.17209 235.89133 198.59036 240.3096 198.59036 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(237.3096 207.01003)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="5.2075866" y="11" textLength="39.33">燃气表 2</tspan></text><path d="M 367.45528 198.59036 L 411.20045 198.59036 C 415.61873 198.59036 419.20045 202.17209 419.20045 206.59036 L 419.20045 221.4297 C 419.20045 225.84798 415.61873 229.4297 411.20045 229.4297 L 367.45528 229.4297 C 363.037 229.4297 359.45528 225.84798 359.45528 221.4297 L 359.45528 206.59036 C 359.45528 202.17209 363.037 198.59036 367.45528 198.59036 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(364.45528 207.01003)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="5.4125866" y="11" textLength="38.92">燃气表 n</tspan></text><line x1="307.65905" y1="137.86308" x2="276.46736" y2="190.0908" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="341.04613" y1="137.7287" x2="374.2734" y2="190.22518" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(318.46475 207.01003)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">…</tspan></text><path d="M 224.69713 258.2874 L 423.12123 258.2874 C 427.5395 258.2874 431.12123 254.70568 431.12123 250.2874 L 431.12123 11.494038 C 431.12123 7.07576 427.5395 3.494038 423.12123 3.494038 L 224.69713 3.494038 C 220.27886 3.494038 216.69713 7.07576 216.69713 11.494038 L 216.69713 250.2874 C 216.69713 254.70568 220.27886 258.2874 224.69713 258.2874 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(221.69713 8.494038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="bold" x="24.66205" y="13" textLength="60">通信运营商</tspan><tspan font-family="Helvetica Neue" font-size="12" font-weight="bold" x="84.66205" y="13" textLength="47.1"> NB-IoT </tspan><tspan font-family="PingFang SC" font-size="12" font-weight="bold" x="131.76205" y="13" textLength="48">网络平台</tspan></text><path d="M 301.90918 29.719488 L 345.90918 29.719488 C 350.32746 29.719488 353.90918 33.30121 353.90918 37.719488 L 353.90918 54.719488 C 353.90918 59.137766 350.32746 62.71949 345.90918 62.71949 L 301.90918 62.71949 C 297.4909 62.71949 293.90918 59.137766 293.90918 54.719488 L 293.90918 37.719488 C 293.90918 33.30121 297.4909 29.719488 301.90918 29.719488 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(298.90918 39.219488)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="50">广域网网关</tspan></text><line x1="323.90918" y1="72.61949" x2="323.90918" y2="82.04384" marker-end="url(#FilledArrow_Marker)" marker-start="url(#FilledArrow_Marker_2)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/></g></g></svg>
</div>
 <center>图 5 系统架构设计</center>
图 5 中，燃气企业数据采集平台通过其网络域内的局域网 NTP 服务器实现数据采集服务集群中的多台服务器之间的时钟同步。通信运营商的 NB-IoT 网络平台通过其域内的广域网网关与燃气企业数据采集平台中的广域网网关实现跨域通信，NB-IoT 通信网络通过无线通信实现与城镇小区居民物联网智能燃气表的通信，最终实现燃气企业数据采集服务集群和城镇小区居民物联网智能燃气表的互联互通。在通信过程中，通过燃气企业自定义的应用层协议实现燃气表和数据采集服务器的时钟同步。考虑到实际工程实现的复杂程度，忽略中间的链路，将端到端的系统进行抽象简化，以采集系统端的单调时钟为时钟基准，进行物联网智能燃气表端系统时钟同步的方法可概括为如图 6 所示的过程。
<div align='center'>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 252" width="30pc" height="21pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-10-21 07:20:46 +0000</dc:date></metadata><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="12" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>同步模式</title><g><title>Layer 1</title><line x1="20.625" y1="54.9375" x2="321.32988" y2="54.9375" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="20.625" y1="194.4375" x2="321.32988" y2="194.4375" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(25.625 13.1875)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="128">采集系统单调时钟</tspan></text><text transform="translate(17.375 216.8125)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="192">物联网智能燃气表单调时钟</tspan></text><text transform="translate(88.75 61.54297)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><line x1="93.75" y1="45.842118" x2="93.75" y2="54.9375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="51" y1="185.34212" x2="51" y2="194.4375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(48.875 194.3125)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="52" y1="174.52679" x2="85.595467" y2="93.19311" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="1,4"/><text transform="translate(77.375 134.6875)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="0" y="13" textLength="72">请求同步时钟</tspan></text><line x1="238.875" y1="185.34212" x2="238.875" y2="194.4375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(239.375 194.3125)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t4</tspan></text><line x1="175.39648" y1="45.842118" x2="175.39648" y2="54.9375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(169.89648 61.54297)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t3</tspan></text><line x1="182.23214" y1="84.04297" x2="229.60263" y2="170.13872" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" stroke-dasharray="1,4"/><text transform="translate(228.125 118.1875)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x="21.5" y="13" textLength="48">下发含有</tspan><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".458" y="30" textLength="90.084">t2, t3的同步消息</tspan></text></g></g></svg></div>
 <center>图 6 端到端的时钟同步设计</center>

图 6 中 物联网智能燃气表在按其单调时钟系统记录的 $t_1$ 时刻发起时钟同步请求，采集系统收到同步请求后，按其单调时钟系统记录收到请求的时刻为 $t_2$，在下发时钟同步消息时按其时钟系统记录时刻为 $t_3$，时钟同步消息中含有  $t_2$ 和 $t_3$ ，当物联网智能燃气表收到时钟同步消息时，按其单调时钟记录时刻为 $t_4$，则物联网智能燃气表可在表端计算获得整个通信过程中的网络传输时间 $t_{n}$：

$$
\begin{equation}
t_{n}=(t_4-t_1)-(t_3-t_2) \tag{2}
\end{equation}
$$
此处的网络传输时间 $t_{n}$ 为双向通信（一个通信往返）的网络传输时间，假定上下行通信的延迟时间是相同的，则可计算出单程网络传输时间，即图 2 中的 $t_{fly time}$：
$$
\begin{align}
t_{fly time} &= \frac{1}{2}t_{n}\\
&=\frac{1}{2}[(t_4-t_1)-(t_3-t_2)] \tag{3}
\end{align}
$$
若实际网络环境中上下行通信的延迟时间不同，则公式（3）中的 $t_{fly time}$ 需要重新计算。图 6 中，表端单调时钟的 $t_1$ 时间戳发送至采集系统后，采集系统按照其单调时钟系统记录的时间戳为 $t_2$ ，考虑公式（3）中的单程网络传输时间 $t_{fly time}$ ，若表端在 $t_2$ 时刻进行时钟调整，则 $t_2$ 时刻表端单调时钟时间戳为 $t_1+t_{fly time}$，则表端可计算其时钟系统和采集系统时钟系统的时间误差 $t_{d}$：

$$
\begin{align}
t_{d}&=t_2-(t_1+t_{fly time})\\
&=t_2-t_1-\frac{1}{2}[(t_4-t_1)-(t_3-t_2)]\\
&=\frac{1}{2}[(t_2-t_1)-(t_4-t_3)]\tag{4}
\end{align}
$$
 表端得到了准确的时钟误差 $t_d$ 后，若在时刻 $t$ 调整其时钟，则时钟调整如下：
$$
\begin{align}
t&=t+ t_d\\
&=t+\frac{1}{2}[(t_2-t_1)-(t_4-t_3)]\tag{5}
\end{align}
$$
考虑到物联网燃气表表端的一些业务逻辑中需获取时钟，时钟调整对表端业务逻辑的影响通过图 7 中的代码片段进行说明。
```c
long t1 = getTime();			// 步骤1: 获取系统时间 t1
do { b1(t1) };					// 步骤2: 处理业务 b1 
sys.time() = sys.time() + td;	// 步骤3: 其他进程按照公式（4）中计算获取的 td 调整系统时间
long t2 = getTime();			// 步骤4: 获取系统时间 t2
long b1_time_used = t2 - t1		// 步骤5: 计算业务 b1 的用时
do { b2(t2) };					// 步骤6: 处理业务 b2
```
<center> 图 7 表端业务逻辑处理代码片段</center>
考虑以下两种情况。

（1）$t_d$ > 0，即表端单调时钟系统滞后于采集系统单调时钟系统，表端需向前步进时间单位 $\left|{t_d}\right|$ 。直接进行调整，可以观察到按照时间记录的业务 $b_1$ 的处理时间延长了时间 $\left|{t_d}\right|$ ，但表端业务发生的时序没有发生变化。

（2）$t_d$ < 0，即表端单调时钟系统超前于采集系统单调时钟系统，表端需要向后步进时间单位 $\left|{t_d}\right|$ 。直接进行调整，则可能会导致表端业务时序混乱。
例如，实际上，按照表具单调时钟系统（滴答时钟，时间只能向前）， $t_1$ 时刻发生 $b_1$ 业务，$t_2$ 时刻发生 $b_2$ 业务，$t_2$ 时刻晚于 $t_1$ 时刻。在 $b_1$ 发生后 $b_2$ 发生前，进行了表具时钟的调整（图 7 中的步骤 3 ），这样从表具的墙面时钟（记录的时间）来看， 业务 $b_2$ 的发生在时间上早于业务 $b_1$ ，出现了“时光倒流”，如图 8 所示。此时，以第三者视角看来，表端的业务时序产生混乱。

<div align='center'><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 288" width="30pc" height="24pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-07-15 06:26:14 +0000</dc:date></metadata><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="12" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>Canvas 3</title><g><title>Layer 1</title><line x1="16.875" y1="92.34538" x2="317.57988" y2="92.34538" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(15.125 38.125)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="288">物联网智能燃气表单调时钟（滴答时钟）</tspan></text><text transform="translate(21.875 246.09538)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="0" y="17" textLength="288">物联网智能燃气表墙面时钟（记录时钟）</tspan></text><line x1="148.875" y1="83.25" x2="148.875" y2="92.34538" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(144.375 94.84538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="235.125" y1="83.25" x2="235.125" y2="92.34538" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(235.625 92.22038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><text transform="translate(142.375 117.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".08" y="13" textLength="63.84">b1 业务发生</tspan></text><text transform="translate(233.625 117.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".386" y="13" textLength="66.228">b2 业务发生</tspan></text><line x1="16.875" y1="192.47038" x2="317.57988" y2="192.47038" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="148.875" y1="183.375" x2="148.875" y2="192.47038" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(144.375 194.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".464" y="13" textLength="9.072">t1</tspan></text><line x1="235.125" y1="183.375" x2="235.125" y2="192.47038" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(235.625 192.34538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".27" y="13" textLength="11.46">t2</tspan></text><text transform="translate(144.375 218.09538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".08" y="13" textLength="63.84">b1 业务发生</tspan></text><text transform="translate(34.25 218.09538)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".386" y="13" textLength="66.228">b2 业务发生</tspan></text><text transform="translate(31.75 194.97038)" fill="black"><tspan font-family="PingFang SC" font-size="12" font-weight="500" x=".21" y="13" textLength="50.58">tx=t2-|d3|</tspan></text><line x1="38.25" y1="183.375" x2="38.25" y2="192.47038" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/></g></g></svg></div>
 <center>图 8 “时光倒流”现象示意图</center>
为了避免出现 “时光倒流”的现象，表具端应按照其实际时钟记录精度（例如 1ms），将需要调整的时钟误差 $\left|{t_d}\right|$ 分割成多个较小的单位，按照逐步逼近的方式，多次进行时钟调整。或者，考虑到表具嵌入式系统中的微控制器实际时间的控制程度<sup>[<a href='#ref19'>19</a>]</sup>，可以使其单调时钟系统的“滴答”变慢，最终实现平滑的时间过渡，避免出现图 8 中的问题，引起业务时序混乱。

# 实验验证

##  实验设计

实验验证环境的网络拓扑如图 9 所示。主机  h<sub>1</sub> 模拟数据采集平台， 主机 h<sub>2</sub> 模拟燃气表具，设定  h<sub>1</sub> 到   h<sub>2</sub>、h<sub>2</sub> 到 h<sub>1</sub> 的端到端网络传输延迟时间为 1s，即 h<sub>1</sub> -h<sub>2</sub> 的网络 RTT（Round Trip Time ，即网络往返时间）为 2s，h<sub>1</sub> -h<sub>2</sub> 的网络带宽设置为 200Kbps，模拟如图 5 所示的实际 NB-IoT 网络的端到端的延迟以及传输带宽<sup>[<a href='#ref20'>20</a>]</sup>。
<div align='center'>
   <svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 324 180" width="27pc" height="15pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-10-21 07:20:46 +0000</dc:date></metadata><defs><font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.99585" descent="-212.99744" font-weight="500"><font-face-src><font-face-name name="HelveticaNeue"/></font-face-src></font-face><font-face font-family="Helvetica Neue" font-size="10" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.99585" descent="-212.99744" font-weight="500"><font-face-src><font-face-name name="HelveticaNeue"/></font-face-src></font-face><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>测试网络拓扑</title><g><title>Layer 1</title><rect x="13.5" y="129.375" width="77.625" height="36" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(18.5 138.151)" fill="black"><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" x="26.5845" y="15" textLength="8.896">h</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="35.4805" y="15" textLength="5.56">1</tspan></text><rect x="232.875" y="129.375" width="77.625" height="36" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(237.875 138.151)" fill="black"><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" x="26.5845" y="15" textLength="8.896">h</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="35.4805" y="15" textLength="5.56">2</tspan></text><line x1="91.125" y1="147.375" x2="232.875" y2="147.375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(127.4375 116.375)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="3.225" y="11" textLength="20">延迟</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="23.225" y="11" textLength="38.55"> 2000ms</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="25" textLength="65">带宽 200Kbps</tspan></text><rect x="123.9375" y="9" width="77.625" height="36" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(128.9375 17.776001)" fill="black"><tspan font-family="Helvetica Neue" font-size="16" font-weight="500" x="26.5845" y="15" textLength="8.896">h</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="35.4805" y="15" textLength="5.56">3</tspan></text><path d="M 123.9375 27 L 116.9375 27 L 52.3125 27 L 52.3125 129.375 L 52.3125 122.375 L 52.3125 129.375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 201.5625 27 L 208.5625 27 L 271.6875 27 L 271.6875 129.375 L 271.6875 122.375 L 271.6875 129.375" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(56.375 65.75)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="7.395" y="11" textLength="20">延迟</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="27.395" y="11" textLength="30.21"> 0.5ms</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x=".035" y="25" textLength="64.93">带宽 100Mbps</tspan></text><text transform="translate(199.5 65.75)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="9.395" y="11" textLength="20">延迟</tspan><tspan font-family="Helvetica Neue" font-size="10" font-weight="500" x="29.395" y="11" textLength="30.21"> 0.5ms</tspan><tspan font-family="PingFang SC" font-size="10" font-weight="500" x=".37" y="25" textLength="68.26">带宽 100 Mbps</tspan></text></g></g></svg>
</div>
<center>图 9 时钟同步实验网络拓扑示意图</center>

主机  h<sub>3</sub> 作为监控机器节点，实时获取节点 h<sub>1</sub> 和节点 h<sub>2</sub> 的系统时间，为了减少引入的时间误差，将 h<sub>3</sub> - h<sub>1</sub>、 h<sub>3</sub> - h<sub>2</sub> 之间的网络带宽设置为 100 Mbps，RTT 设置为 0.5 ms。  h<sub>1</sub>、 h<sub>2</sub> 、h<sub>3</sub> 3 个节点中的数据传输采用 TCP 协议。

（1）按照简单时间戳下发的方法进行时钟同步，通过 h<sub>3</sub> 记录时钟同步后主机 h<sub>1</sub> 和 h<sub>2 </sub>的时钟，计算时钟差；

（2）按照本文设计的如图 6 和公式（4）所示的基于时间戳计算网络传输时延的时钟同步方法进行时钟同步，通过 h<sub>3</sub> 记录时钟同步后主机 h<sub>1</sub> 和 h<sub>2 </sub>的时间差，与（1）进行比较，查看时钟同步精度的提升程度。

##  软件设计

本文设计的时钟同步为单向时钟同步方式，两端为服务端（数据采集平台端）和客户端（智能燃气表端），服务端将其时钟单向同步至客户端。

（1）智能燃气表端。智能燃气表端作为客户端，主动发起时钟同步请求，其软件流程设计如图 10 所示。
<div align='center'>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 432" width="30pc" height="36pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-10-21 07:20:46 +0000</dc:date></metadata><defs><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>时间同步客户端</title><g><title>Layer 1</title><path d="M 135.892255 6.75 L 180.64225 6.75 C 185.06053 6.75 188.64225 10.331722 188.64225 14.75 L 188.64225 25.75 C 188.64225 30.168278 185.06053 33.75 180.64225 33.75 L 135.892255 33.75 C 131.47398 33.75 127.892255 30.168278 127.892255 25.75 L 127.892255 14.75 C 127.892255 10.331722 131.47398 6.75 135.892255 6.75 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(132.892255 9.25)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">开始</tspan></text><rect x="103.68026" y="47.082405" width="109.2183" height="42.75" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.68026 46.457405)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">获取当前</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">系统时间</tspan></text><rect x="103.68026" y="105.31254" width="109.2183" height="42.75" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.68026 104.68754)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">发送时钟</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">同步请求</tspan></text><line x1="158.26725" y1="33.75" x2="158.28941" y2="47.082405" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="158.28941" y1="89.832405" x2="158.28941" y2="105.31254" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="103.478867" y="164.41505" width="109.2183" height="42.75" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.47887 163.79005)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">等待接收</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">应答报文</tspan></text><line x1="158.28941" y1="148.06254" x2="158.08802" y2="164.41505" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 158.26725 220.5 L 236.65951 250.54167 L 158.26725 280.58333 L 79.875 250.54167 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(106.04091 227.94083)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="21.794191" y="17" textLength="64">报文接收</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="29.794191" y="39" textLength="48">成功？</tspan></text><line x1="158.08802" y1="207.16505" x2="158.26725" y2="220.5" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="103.76918" y="302.42395" width="109.2183" height="30.595564" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.76918 306.72174)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">计算时间误差</tspan></text><path d="M 236.65951 250.54167 L 248.55951 250.54167 L 258.64312 250.54167 L 258.64312 233.72814 L 258.74617 222.55579 L 258.74617 126.68754 L 224.79856 126.68754 L 222.79856 126.68754" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="158.26725" y1="280.58333" x2="158.37833" y2="302.42395" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="103.68026" y="353.45245" width="109.2183" height="30.595564" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(108.68026 357.75024)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">调整系统时间</tspan></text><line x1="158.37833" y1="333.01952" x2="158.28941" y2="353.45245" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(241.65951 231.625)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">否</tspan></text><text transform="translate(164.90529 281.92135)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">是</tspan></text><path d="M 136.28136 401.19358 L 181.03136 401.19358 C 185.44964 401.19358 189.03136 404.7753 189.03136 409.19358 L 189.03136 420.19358 C 189.03136 424.61186 185.44964 428.19358 181.03136 428.19358 L 136.28136 428.19358 C 131.86308 428.19358 128.28136 424.61186 128.28136 420.19358 L 128.28136 409.19358 C 128.28136 404.7753 131.86308 401.19358 136.28136 401.19358 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(133.28136 403.69358)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">结束</tspan></text><line x1="158.28941" y1="384.04802" x2="158.65636" y2="401.19358" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/></g></g></svg>
</div>
<center>图 10 智能燃气表端软件流程设计示意图</center>

（2）数据采集平台端。 数据采集平台端作为服务端，响应客户端的时钟同步请求， 其软件流程设计如图 11 所示。
<div align='center'>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 360 468" width="30pc" height="39pc" xmlns:dc="http://purl.org/dc/elements/1.1/"><metadata> Produced by OmniGraffle 6.6 <dc:date>2022-10-21 07:27:20 +0000</dc:date></metadata><defs><font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black"><g><path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/></g></marker><font-face font-family="PingFang SC" font-size="10" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.00215" descent="-340.00069" font-weight="500"><font-face-src><font-face-name name="PingFangSC-Regular"/></font-face-src></font-face></defs><g stroke="none" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1"><title>时间同步服务端</title><g><title>Layer 1</title><path d="M 140.97765 15.023365 L 185.72765 15.023365 C 190.14593 15.023365 193.72765 18.605087 193.72765 23.023365 L 193.72765 34.023365 C 193.72765 38.441643 190.14593 42.023365 185.72765 42.023365 L 140.97765 42.023365 C 136.55937 42.023365 132.97765 38.441643 132.97765 34.023365 L 132.97765 23.023365 C 132.97765 18.605087 136.55937 15.023365 140.97765 15.023365 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(137.97765 17.523365)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">开始</tspan></text><rect x="108.76566" y="59.033266" width="109.2183" height="32.67739" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.76566 64.37196)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">服务启动</tspan></text><rect x="108.76566" y="109.163216" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.76566 109.34564)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="17" textLength="64">时钟同步</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="17.609151" y="39" textLength="64">请求监听</tspan></text><line x1="163.35265" y1="42.023365" x2="163.37481" y2="59.033266" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="163.37481" y1="91.710657" x2="163.37481" y2="109.163216" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><path d="M 163.32975 170.40827 L 229.90951 195.27089 L 163.32975 220.13351 L 96.75 195.27089 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(119.726534 183.77364)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="4.934816" y="17" textLength="80">请求到达？</tspan></text><rect x="108.585396" y="240.69787" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.585396 240.8803)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">记录接收请求</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="25.60915" y="39" textLength="48">时间戳</tspan></text><path d="M 229.90951 195.27089 L 241.80951 195.27089 L 264.49218 195.27089 L 264.49218 148.96533 L 264.49218 131.34564 L 229.88396 131.34564 L 227.88396 131.34564" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="163.32975" y1="220.13351" x2="163.19455" y2="240.69787" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="108.585396" y="304.28327" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.585396 304.4657)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">组装时钟同步</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="33.60915" y="39" textLength="32">报文</tspan></text><line x1="163.19455" y1="285.06272" x2="163.19455" y2="304.28327" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(246.7449 177.93302)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">否</tspan></text><text transform="translate(168.7104 220.90827)" fill="black"><tspan font-family="PingFang SC" font-size="10" font-weight="500" x="0" y="11" textLength="10">是</tspan></text><path d="M 140.77674 429.15827 L 185.52674 429.15827 C 189.94501 429.15827 193.52674 432.74 193.52674 437.15827 L 193.52674 448.15827 C 193.52674 452.57654 189.94501 456.15827 185.52674 456.15827 L 140.77674 456.15827 C 136.35846 456.15827 132.77674 452.57654 132.77674 448.15827 L 132.77674 437.15827 C 132.77674 432.74 136.35846 429.15827 140.77674 429.15827 Z" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(137.77674 431.65827)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="9.375" y="17" textLength="32">结束</tspan></text><line x1="163.19455" y1="348.64812" x2="163.21535" y2="367.28327" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><line x1="163.37481" y1="153.52807" x2="163.32975" y2="170.40827" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><rect x="108.606196" y="367.28327" width="109.2183" height="44.36485" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/><text transform="translate(113.606196 367.4657)" fill="black"><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="1.6091505" y="17" textLength="96">发送时钟同步</tspan><tspan font-family="PingFang SC" font-size="16" font-weight="500" x="33.60915" y="39" textLength="32">报文</tspan></text><line x1="163.21535" y1="411.64812" x2="163.15174" y2="429.15827" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/></g></g></svg>
</div>
<center>图 11 数据采集平台端的软件流程设计示意图</center>

## 实验结果

（1）采用简单时间戳下发时钟同步方法进行时间同步后，通过 h<sub>3</sub> 采集 h<sub>1</sub>、h<sub>2</sub> 的系统时钟进行比较，测试数据结果如表 1 所示。

<center>表 1  简单时间戳下发时钟同步实验数据</center>

| No   | 服务端（h<sub>1</sub>）时钟   | 客户端（h<sub>2</sub>）时钟   | 客户端（h<sub>2</sub>）相对于服务端（h<sub>1</sub>）的时钟误差（秒） |
| ---- | ----------------------------- | ----------------------------- | ------------------------------------------------------------ |
| 1    | 2022-09-13 01:03:33.756735148 | 2022-09-13 01:03:32.754114941 | -1.002620207                                                 |
| 2    | 2022-09-13 01:09:01.294784790 | 2022-09-13 01:09:00.291277131 | -1.003507659                                                 |
| 3    | 2022-09-13 01:10:14.622645045 | 2022-09-13 01:10:13.617068747 | -1.005576298                                                 |
| 4    | 2022-09-13 01:11:17.043157179 | 2022-09-13 01:11:16.039954676 | -1.003202503                                                 |
| 5    | 2022-09-13 01:12:58.703954615 | 2022-09-13 01:12:57.700283630 | -1.003670985                                                 |
| 6    | 2022-09-13 01:16:49.247449445 | 2022-09-13 01:16:48.245001725 | -1.002447720                                                 |
| 7    | 2022-09-13 01:18:09.648775703 | 2022-09-13 01:18:08.645985074 | -1.002790629                                                 |
| 8    | 2022-09-13 01:19:17.876719710 | 2022-09-13 01:19:16.872976216 | -1.003743494                                                 |
| 9    | 2022-09-13 01:20:24.088706231 | 2022-09-13 01:20:23.085022746 | -1.003683485                                                 |
| 10   | 2022-09-13 01:21:21.162689323 | 2022-09-13 01:21:20.160310589 | -1.002378734                                                 |

由表 1 可见， 同步后 h<sub>2</sub> 的时钟相对于 h<sub>1</sub>误差大约为 1s，即通过简单时间戳下发的同步方法，将至少引入一个网络传输延迟的时间。
（2）采用基于时间戳计算网络传输时延的时钟同步方法进行时钟同步。公式（3）中的 $t_{fly time}$ 计算结果是基于上下行通信的网络延迟时间相同的前提条件，本文中由于 h<sub>1</sub>和 h<sub>2</sub> 的通信是基于 TCP 进行的，h<sub>2</sub> 到 h<sub>1</sub> 的上行通信中 TCP 建立连接经历了 3 个网络传输延迟时间 <sup>[<a href='#ref21'>21</a>]</sup> ，h<sub>1</sub> 到 h<sub>2</sub> 的下行通信延迟时间是网络传输延迟时间的 1 倍，所以 $t_{fly time}$ 应按照公式（6）计算：
$$
\begin{align}
t_{fly time} &= \frac{1}{4}t_{n}\\
&=\frac{1}{4}[(t_4-t_1)-(t_3-t_2)] \tag{6}
\end{align}
$$

依据公式（6）对网络延迟计算进行校正后，时钟同步测试结果如表 2 所示。
<center>表 2  基于时间戳计算网络传输时延的时钟同步实验数据</center>
| No   | 服务端（h<sub>1</sub>）时钟   | 客户端（h<sub>2</sub>）时钟   | 客户端（h<sub>2</sub>）相对于服务端（h<sub>1</sub>）的时钟误差（秒） |
| ---- | ----------------------------- | ----------------------------- | ------------------------------------------------------------ |
| 1    | 2022-09-13 06:02:22.406935025 | 2022-09-13 06:02:22.403398931 | -0.003536094                                                 |
| 2    | 2022-09-13 06:04:00.703037142 | 2022-09-13 06:04:00.701504316 | -0.001532826                                                 |
| 3    | 2022-09-13 06:05:40.831728567 | 2022-09-13 06:05:40.828565694 | -0.003162873                                                 |
| 4    | 2022-09-13 06:07:26.219024048 | 2022-09-13 06:07:26.217180293 | -0.001843755                                                 |
| 5    | 2022-09-13 06:08:47.532350041 | 2022-09-13 06:08:47.528317173 | -0.004032868                                                 |
| 6    | 2022-09-13 06:09:44.996219566 | 2022-09-13 06:09:44.992700046 | -0.003519520                                                 |
| 7    | 2022-09-13 06:10:39.904512280 | 2022-09-13 06:10:39.901961137 | -0.002551143                                                 |
| 8    | 2022-09-13 06:11:30.578166514 | 2022-09-13 06:11:30.575262957 | -0.002903557                                                 |
| 9    | 2022-09-13 06:12:21.581112755 | 2022-09-13 06:12:21.579993858 | -0.001118897                                                 |
| 10   | 2022-09-13 06:13:11.332194301 | 2022-09-13 06:13:11.330426183 | -0.001768118                                                 |

通过表 2 所示的实验数据可以看出，采用基于时间戳计算网络传输时延的时钟同步方法，在实验环境下的时钟同步精度可以达到 5ms 。

# 总结

使用基于时间戳计算网络传输时延的时钟同步方法，可以在实验环境下的燃气表具端达到误差为 5 ms 的时钟同步精度，而采用简单的时间戳下发的时钟同步方法，则至少会引入一个网络传输时间的误差，在本文如图 9 所示的网络条件下此误差为 1 s， 可见通过采用基于时间戳计算网络传输时延的时钟同步方法，想对于简单时间戳下发的时钟同步方法，时钟同步精度由 1s 提升至 5 ms，时钟精度提升了99.5%。后续还需要在实际的智能燃气表具的嵌入式系统中实现如图 10 所示的软件逻辑，并与现有的燃气企业自定义应用层协议相结合，进一步验证在实际表具终端和通信运营商网络环境中的时钟同步精度。同时，还需要考虑当表端时钟调整超过 1ms 时，在燃气表具端需采用分阶段调整的方法，以防止引起如图 7 所示的表端业务时序逻辑问题。

# 参考文献

 <a name ='ref1'>[1]</a> 瞿浡麟. 试论 NB-IoT 物联网智能燃气表及其应用[C].中国燃气运营与安全研讨会（第十一届）暨中国土木工程学会燃气分会2021年学术年会论文集（上册）.2021: 691-696. DOI:10.26914/c.cnkihy.2021.061668.

<a name ='ref2'>[2]</a> 田小梦. ITU正式将NB-IoT技术纳入5G标准体系促进全球5G发展[J]. 通信世界, 2020(20): 29-30. DOI: 10.13571/j.cnki.cww.2020.20.014.

<a name ='ref3'>[3]</a> 刘兴伟, 陈婷婷, 法曙光. 城镇燃气计量仪表智能化标准发展探讨[J]. 煤气与热力,2022, 42(05): 44-46. DOI: 10.13608/j. cnki. 1000-4416.2022.05.018.

<a name ='ref4'>[4]</a> 郑红立,刘航,胡洋.NB-IoT技术在物联网智能燃气表领域的应用与推广[J]. 城市燃气,2021(08):6-11.

<a name ='ref5'>[5]</a> Bo Xue, Zhitian Li, Pengyu Lei, Yingzi Wang, Xudong Zou. Wicsync: A wireless multi-node clock synchronization solution based on optimized UWB two-way clock synchronization protocol[J], Measurement,2021(183).

<a name ='ref6'>[6]</a> Yamamoto Koutarou, Fukuhara Akihiro, Nishi Hiroaki. Hardware Implementation of MQTT Broker and Precise Time Synchronization Using IoT Devices[J], IEEJ Transactions on Electrical and Electronic Engineering, 2021, 17(2): 209-217.DOI:10.1002/TEE.23511.

<a name ='ref7'>[7]</a> Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI (RFC 2030), https://www.rfc-editor.org/rfc/rfc4330. 

<a name ='ref8'>[8]</a> Network Time Protocol Version 4: Protocol and Algorithms Specification (RFC 5905), https://datatracker.ietf.org/doc/rfc5905/.

<a name ='ref9'>[9]</a> 孙建鹏,刘欣,洪应平,何鑫,熊继军.基于DP83640的以太网时钟同步方法设计[J].电子学报,2021,49(05):1033-1040.

<a name ='ref10'>[10]</a>  Nagra Aamir Sohail, Allahi Irfan, Pasha Muhammad etc. Design and FPGA based Implementation of IEEE 1588 Precision Time Protocol for Synchronisation in Distributed IoT Applications[J]. Australian Journal of Electrical and Electronics Engineering, 2022, 19(1): 31-39. DOI: 10.1080/1448837X.2021.2013407.

<a name ='ref11'>[11]</a> 凤良山,李俊.一种域控制器片内及片外时间同步的方法[J]. 汽车实用技术, 2022,47(01): 61-64. DOI: 10.16638/j.cnki.1671-7988.2022.001.014.

<a name ='ref12'>[12]</a> 胡莽. NB-IoT 无线远传智能燃气表的设计与研究[C]//.中国燃气运营与安全研讨会（第十届）暨中国土木工程学会燃气分会2019年学术年会论文集（中册）.2019: 194-198. DOI: 10.26914/c.cnkihy.2019.021995.

<a name ='ref13'>[13]</a> 肖蕾,崔建峰.基于 NTP 协议的物联网时间同步设备的设计与实现[J]. 邵阳学院学报(自然科学版), 2016,13(03): 46-51.

<a name ='ref14'>[14]</a> 王照伟,曾鹏,于海斌.工业物联网环境下的时间同步技术分析[J]. 中兴通讯技术:1-8 [2022-09-05]. http://kns.cnki.net/kcms/detail/34.1228.TN.20190131.1438.010.html.

<a name ='ref15'>[15]</a> 邵泽华.物联网智能燃气表实施阶梯气价计费的途径[J]. 煤气与热力, 2020, 40(06): 25-26+46. DOI: 10.13608/j.cnki.1000-4416.2020.06.017.

<a name ='ref16'>[16]</a> 刘哲,曾伟,蔡凯.NB-IoT网络指标体系研究与应用[J]. 邮电设计技术, 2020(12): 56-60.

<a name ='ref17'>[17]</a> 杨观止,陈鹏飞,崔新凯,侯维岩.NB-IoT综述及性能测试[J]. 计算机工程, 2020, 46(01): 1-14.DOI: 10.19678/j.issn.1000-3428.0055006.

<a name ='ref18'>[18]</a> 邵泽华,张磊.智能燃气表物联网系统设计[J]. 物联网技术, 2021,11(06):55-57+61.DOI:10.16667/j.issn.2095-1302.2021.06.016.

<a name ='ref19'>[19]</a> 吴天强,叶敏,朱剑,潘超.单片机系统实时时钟日差补偿的算法设计[J].科技风,2019(34):10-11.DOI:10.19392/j.cnki.1671-7341.201934010.

<a name ='ref20'>[20]</a> 邹玉龙,丁晓进,王全全.NB-IoT关键技术及应用前景[J]. 中兴通讯技术, 2017, 23(01): 43-46.

<a name ='ref21'>[21]</a> 陈昱琦.网络安全之TCP/IP协议[J].科技风, 2021(16): 77-78.DOI:10.19392/j.cnki.1671-7341.202116037.



<div>通信作者介绍：刘永成，男，1983年11月生，工学硕士研究生。研究方向为计算机网络通信，网络仿真. E-mail： liuyngchng@163.com </div>
